<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Agent/Brokerage Zones — Mapbox</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    .controls {
      position:absolute; top:10px; left:10px; background:#fff; padding:8px 10px;
      border-radius:6px; box-shadow:0 1px 6px rgba(0,0,0,.2); font:12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .modal {
      position:absolute; right:10px; top:10px; width:320px; max-width:90vw;
      background:#fff; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,.2);
      padding:12px 14px; display:none;
    }
    .modal h3 { margin:0 0 6px; font-size:16px; }
    .modal dt { font-weight:600; }
    .modal dd { margin:0 0 6px; }
    .close { position:absolute; top:6px; right:8px; border:0; background:transparent; font-size:18px; cursor:pointer; }
    .toggle { display:block; margin:4px 0; }
  </style>
</head>
<body>
<div id="map"></div>

<div class="controls">
  <div>
    <label><input type="radio" name="mode" value="agent" checked> Agent</label>
    <label><input type="radio" name="mode" value="brokerage"> Brokerage</label>
  </div>
  <label class="toggle"><input id="toggle-zones" type="checkbox" checked> Show Zones</label>
  <label class="toggle"><input id="toggle-points" type="checkbox" checked> Show Points</label>
</div>

<div class="modal" id="infoModal">
  <button class="close" id="closeModal" aria-label="Close">×</button>
  <h3 id="modalTitle"></h3>
  <dl id="modalBody"></dl>
</div>

<script>
  // ======= 1) Config =======
  const MAPBOX_TOKEN = 'pk.eyJ1IjoidHJkZGF0YSIsImEiOiJjamc2bTc2YmUxY2F3MnZxZGh2amR2MTY5In0.QlOWqB-yQNrNlXD0KQ9IvQ';
  const MODE_DEFAULT = 'agent'; // 'agent' | 'brokerage'

  const files = {
    agent: {
      points: 'agents_points.geojson',
      hulls:  'agents_hulls.geojson',
      titleField: 'Agent_Name',
      groupLabel: 'Agent'
    },
    brokerage: {
      points: 'brokerages_points.geojson',
      hulls:  'brokerages_hulls.geojson',
      titleField: 'Brokerage_Firm',
      groupLabel: 'Brokerage'
    }
  };

  // Your modal field spec (like your snippet)
  const modalDisplayFields = {
    title: { field: 'TitleDisplay', label: 'Developers' }, // we’ll overwrite label per mode
    content: [
      { field: 'Address', label: 'Address' },
      { field: 'Status', label: 'Status' },
      { field: 'Live Local Units', label: 'Live Local Units' },
      { field: 'Total Units', label: 'Total Units' },
      { field: 'Percent Live Local', label: 'Percent Live Local' },
      { field: 'DescriptionDisplay', label: '' },
      { field: 'Story', label: 'Recent Coverage' },
      { field: 'priceDisplay', label: 'Price' },
      { field: 'Side', label: 'Side' },
      { field: 'Agent_Name', label: 'Agent' },
      { field: 'Brokerage_Firm', label: 'Brokerage' }
    ]
  };

  // ======= 2) Utils =======
  const isBlank = (v) => {
    if (v == null) return true;
    const s = String(v).trim();
    if (!s) return true;
    const lower = s.toLowerCase();
    return ['none','null','n/a','na','—','-','undefined'].includes(lower);
  };
  const clean = (v) => (isBlank(v) ? '' : String(v).trim());
  const fmtMoney = (v) => {
    if (v == null || v === '') return '';
    const n = Number(v);
    if (!isFinite(n)) return clean(v);
    return n.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
  };
  const hashColor = (str) => {
    if (!str) return '#007cbf';
    let h = 0;
    for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) | 0;
    const hue = Math.abs(h) % 360;
    return `hsl(${hue},70%,45%)`;
  };

  // ======= 3) Map init =======
  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [-80.25541324712269, 25.812643434438264,],  // ✅ around Boca Raton / midpoint of the tri-county area
    zoom: 8.5                // ✅ wide enough to include Miami-Dade up through Palm Beach
  });

  let currentMode = MODE_DEFAULT;

  // Build sources/layers for a mode
  async function loadMode(mode) {
    currentMode = mode;
    const cfg = files[mode];

    // Remove old layers/sources if present
    ['zones-fill','zones-outline','points'].forEach(id => {
      if (map.getLayer(id)) map.removeLayer(id);
    });
    ['zones','points'].forEach(id => {
      if (map.getSource(id)) map.removeSource(id);
    });

    // Add sources
    map.addSource('zones', { type: 'geojson', data: cfg.hulls });
    map.addSource('points', {
      type: 'geojson',
      data: await preprocessPoints(cfg)  // mutate properties for display
    });

    // Add zone layers
    map.addLayer({
      id: 'zones-fill',
      type: 'fill',
      source: 'zones',
      paint: { 'fill-opacity': 0.22, 'fill-color': '#0066cc' },
      layout: { visibility: document.getElementById('toggle-zones').checked ? 'visible' : 'none' }
    });
    map.addLayer({
      id: 'zones-outline',
      type: 'line',
      source: 'zones',
      paint: { 'line-width': 1.5, 'line-color': '#002d72', 'line-opacity': 0.9 },
      layout: { visibility: document.getElementById('toggle-zones').checked ? 'visible' : 'none' }
    });

    // Add point layer
    map.addLayer({
      id: 'points',
      type: 'circle',
      source: 'points',
      paint: {
        'circle-color': ['get','_categoryColor'],
        'circle-stroke-color': '#f1f1f1',
        'circle-stroke-width': 1.5,
        'circle-radius': ['get','_radius']
      },
      layout: { visibility: document.getElementById('toggle-points').checked ? 'visible' : 'none' }
    });

    // Click => open modal
    map.on('click', 'points', (e) => {
      const f = e.features && e.features[0];
      if (!f) return;
      openModal(f.properties);
    });
    map.on('mousemove', 'points', () => (map.getCanvas().style.cursor = 'pointer'));
    map.on('mouseleave', 'points', () => (map.getCanvas().style.cursor = ''));
  }

  // Preprocess point properties for display and styling
  async function preprocessPoints(cfg) {
    const res = await fetch(cfg.points);
    const data = await res.json();
    data.features = (data.features || []).map((feature) => {
      const p = { ...(feature.properties || {}) };

      // Title
      const titleRaw = clean(p[cfg.titleField]);
      p.TitleDisplay = titleRaw;

      // Presentational fields
      const desc = clean(p.Description);
      p.DescriptionDisplay = desc ? `<em>${desc}</em>` : '';
      const story = clean(p['Recent Coverage']);
      p.Story = story ? `<a href="${story}" target="_blank" rel="noopener">Open story</a>` : '';
      p.Address = clean(p.Address);

      // Extra fields you asked for
      p.priceDisplay = fmtMoney(p.price);

      // Styling data
      p._categoryColor = hashColor(titleRaw);

      // Radius by price with caps
      const n = Number(p.price);
      p._radius = isFinite(n) ? Math.max(4, Math.min(14, Math.sqrt(n) / 300)) : 8;

      feature.properties = p;
      return feature;
    });
    return data;
  }

  // ======= 4) Modal behavior =======
  const modal = document.getElementById('infoModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  document.getElementById('closeModal').addEventListener('click', () => (modal.style.display = 'none'));

  function openModal(props) {
    // Title label per mode
    modalDisplayFields.title.label = (currentMode === 'agent') ? 'Agent' : 'Brokerage';
    modalTitle.textContent = props[modalDisplayFields.title.field] || '(No title)';

    // Build content
    modalBody.innerHTML = '';
    for (const item of modalDisplayFields.content) {
      const val = props[item.field];
      if (isBlank(val)) continue;
      const dt = document.createElement('dt');
      const dd = document.createElement('dd');
      if (item.label) dt.textContent = item.label;
      else dt.textContent = ''; // empty label row
      if (typeof val === 'string' && val.includes('<em>') || val.includes('<a ')) {
        dd.innerHTML = val; // allow our presentational HTML
      } else {
        dd.textContent = val;
      }
      modalBody.appendChild(dt);
      modalBody.appendChild(dd);
    }
    modal.style.display = 'block';
  }

  // ======= 5) UI toggles =======
  document.querySelectorAll('input[name="mode"]').forEach(r => {
    r.addEventListener('change', (e) => {
      const mode = e.target.value;
      loadMode(mode);
    });
  });

  document.getElementById('toggle-zones').addEventListener('change', (e) => {
    const vis = e.target.checked ? 'visible' : 'none';
    if (map.getLayer('zones-fill'))   map.setLayoutProperty('zones-fill', 'visibility', vis);
    if (map.getLayer('zones-outline'))map.setLayoutProperty('zones-outline', 'visibility', vis);
  });

  document.getElementById('toggle-points').addEventListener('change', (e) => {
    const vis = e.target.checked ? 'visible' : 'none';
    if (map.getLayer('points')) map.setLayoutProperty('points', 'visibility', vis);
  });

  // ======= 6) Boot =======
  map.on('load', () => loadMode(MODE_DEFAULT));
</script>
</body>
</html>
