<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grouped Bubble Chart by Race and Outcome</title>
  <!-- Load D3.js from CDN -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
    }
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      pointer-events: none;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }
    .bubble {
      cursor: pointer;
      stroke: #fff;
      stroke-width: 1px;
    }
    .raceLabel {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Grouped Bubble Chart by Race and Outcome</h2>
  <!-- SVG container -->
  <svg width="960" height="600"></svg>
  <!-- Tooltip -->
  <div class="tooltip"></div>

  <script>
    // Candidate data with donations in dollars, win/loss status, and race name.
    const data = [
      { candidate: "Brian Brubaker", donations: 13387.80, won: true, race: "Mayor of Round Lake" },
      { candidate: "Chris Brown", donations: 12140.28, won: true, race: "Mayor of Morris" },
      { candidate: "Chris Curtis", donations: 10388.64, won: true, race: "Mayor of Kankakee" },
      { candidate: "Clare Kelly", donations: 17233.85, won: true, race: "Evanston City Council (1st Ward)" },
      { candidate: "Colin Gilbert", donations: 31766.64, won: false, race: "Arlington Heights Trustee" },
      { candidate: "Damon Zdunich", donations: 25810.50, won: false, race: "Joliet Trustee" },
      { candidate: "Dan Brady", donations: 41782.12, won: true, race: "Bloomington Mayor" },
      { candidate: "David Goins", donations: 14391.95, won: true, race: "Alton Mayor" },
      { candidate: "Elizabeth Davies", donations: 22061.45, won: true, race: "Grayslake Mayor" },
      { candidate: "Elizabeth Hellrung", donations: 8502.55, won: true, race: "Troy Alderman (Ward 1)" },
      { candidate: "Greg Klemstein", donations: 5315.90, won: false, race: "Johnsburg Village Trustee" },
      { candidate: "Jennifer Bruzan Taylor", donations: 16319.02, won: false, race: "Naperville City Council" },
      { candidate: "John Pritchard", donations: 10400.85, won: false, race: "Galesburg Mayor" },
      { candidate: "Kathleen Lorenz", donations: 27591.96, won: false, race: "Normal Mayor" },
      { candidate: "LaTonya Jones", donations: 11948.85, won: false, race: "Hazel Crest Village Trustee" },
      { candidate: "Madelyn Staack", donations: 17887.29, won: false, race: "Avon Township Trustee" },
      { candidate: "Mike Adrieansen", donations: 2655.30, won: true, race: "Mayor of Manhattan" },
      { candidate: "Parielle Davis", donations: 19152.58, won: true, race: "Evanston City Council (7th Ward)" },
      { candidate: "Quin O'Brien", donations: 44324.92, won: false, race: "Mayor of Gurnee" },
      { candidate: "Richard McLaughlin", donations: 3998.85, won: true, race: "Mayor of Island Lake" },
      { candidate: "Rick Lauschke", donations: 11264.32, won: true, race: "Godfrey Village Trustee" },
      { candidate: "Robert Seminary", donations: 6121.50, won: true, race: "Mayor of Round Lake Park" },
      { candidate: "Tom Suffredin", donations: 19359.87, won: true, race: "Evanston City Council (6th Ward)" }
    ];

    // Preprocess: assign a simplified race category.
    // This example extracts keywords; you can adjust the logic as needed.
    data.forEach(d => {
      if (d.race.includes("Mayor")) d.category = "Mayor";
      else if (d.race.includes("Council")) d.category = "Council";
      else if (d.race.includes("Trustee")) d.category = "Trustee";
      else if (d.race.includes("Alderman")) d.category = "Alderman";
      else d.category = d.race;
    });

    // Get unique categories (races)
    const raceTypes = [...new Set(data.map(d => d.category))];

    // Set up SVG dimensions
    const width = 960,
          height = 600;
    const svg = d3.select("svg")
                  .attr("width", width)
                  .attr("height", height);
    const tooltip = d3.select(".tooltip");

    // Create a scale for bubble radii (using sqrt scale so that area scales with donations)
    const radiusScale = d3.scaleSqrt()
                          .domain(d3.extent(data, d => d.donations))
                          .range([10, 50]);

    // Color scale: winners in green, losers in red
    const colorScale = d3.scaleOrdinal()
                         .domain([true, false])
                         .range(["#4CAF50", "#F44336"]);

    // Create circles for each candidate with an initial random position.
    const circles = svg.selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("class", "bubble")
        .attr("r", d => radiusScale(d.donations))
        .attr("fill", d => colorScale(d.won))
        .attr("cx", Math.random() * width)
        .attr("cy", Math.random() * height)
        .on("mouseover", (event, d) => {
          tooltip.transition().duration(200)
                 .style("opacity", 0.9);
          tooltip.html(`<strong>${d.candidate}</strong><br/>
                        Donations: $${d.donations.toLocaleString()}<br/>
                        Race: ${d.race}<br/>
                        Outcome: ${d.won ? "Won" : "Lost"}`)
                 .style("left", (event.pageX + 10) + "px")
                 .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", () => {
          tooltip.transition().duration(500)
                 .style("opacity", 0);
        });

    // Define functions to compute target positions based on race and outcome.
    // For horizontal grouping, assign an x-coordinate for each race category.
    function getX(d) {
      const index = raceTypes.indexOf(d.category);
      const columnWidth = width / raceTypes.length;
      // Place the target in the middle of the corresponding column.
      return columnWidth / 2 + index * columnWidth;
    }
    // For vertical grouping, winners are assigned to one row and losers to another.
    function getY(d) {
      return d.won ? height / 3 : 2 * height / 3;
    }

    // Create a force simulation that moves bubbles toward their target positions.
    const simulation = d3.forceSimulation(data)
                          .force("x", d3.forceX(d => getX(d)).strength(0.1))
                          .force("y", d3.forceY(d => getY(d)).strength(0.1))
                          // A collision force prevents overlapping bubbles.
                          .force("collide", d3.forceCollide(d => radiusScale(d.donations) + 2))
                          .on("tick", ticked);

    // Update circle positions on each simulation tick.
    function ticked() {
      circles.attr("cx", d => d.x)
             .attr("cy", d => d.y);
    }

    // Optionally, you can add headers for each race category.
    svg.selectAll(".raceLabel")
       .data(raceTypes)
       .enter()
       .append("text")
       .attr("class", "raceLabel")
       .attr("x", (d, i) => (width / raceTypes.length) * (i + 0.5))
       .attr("y", 20)
       .attr("text-anchor", "middle")
       .text(d => d);
  </script>
</body>
</html>
