<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Legislator Vote Dashboard</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM (deferred for performance) -->
  <script defer crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script defer crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <!-- Babel for in-browser JSX transpilation (remove in production) -->
  <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="h-full bg-gray-100">
  <div id="root" class="p-6"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Simple loading spinner
    function Spinner() {
      return (
        <div className="flex justify-center items-center h-64">
          <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
      );
    }

    // Header with search, party filter, expand/collapse all, and stats
    function DashboardHeader({ controls }) {
      return (
        <div className="mb-6 space-y-4">
          <div className="flex flex-wrap items-center gap-4">
            <input
              type="text"
              placeholder="Search legislators..."
              value={controls.searchText}
              onChange={e => controls.setSearchText(e.target.value)}
              className="p-2 border rounded flex-grow"
            />
            <select
              value={controls.selectedParty}
              onChange={e => controls.setSelectedParty(e.target.value)}
              className="p-2 border rounded"
            >
              <option value="">All Parties</option>
              <option value="D">Democrat</option>
              <option value="R">Republican</option>
            </select>
            <button

              onClick={() => controls.setExpandAll(!controls.expandAll)}
              className="px-4 py-2 bg-blue-600 text-white rounded"
            >
              {controls.expandAll ? 'Collapse All' : 'Expand All'}
            </button>
          </div>
          <div className="flex flex-wrap gap-6 text-gray-700">
            <div><strong>Legislators:</strong> {controls.stats.legislatorCount}</div>
            <div><strong>Bills:</strong> 235</div>
            <div><strong>Yea %:</strong> {controls.stats.yeaPercent.toFixed(1)}</div>
            <div><strong>Nay %:</strong> {controls.stats.nayPercent.toFixed(1)}</div>
          </div>
        </div>
      );
    }

    // Card component for each legislator
    function LegislatorCard({ leg, expandAll }) {
      const [expandedTopics, setExpandedTopics] = useState({});
      useEffect(() => {
        // Sync expand/collapse state for all topics
        const map = {};
        Object.keys(leg.topicCounts).forEach(t => { map[t] = expandAll; });
        setExpandedTopics(map);
      }, [expandAll]);

      return (
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-xl font-semibold text-gray-900 truncate">{leg.legislator_name}</h2>
          <span
            className={`inline-block px-3 py-1 rounded-full text-sm font-medium mt-2 ${
              leg.legislator_party === 'D' ? 'bg-blue-100 text-blue-800' :
              leg.legislator_party === 'R' ? 'bg-red-100 text-red-800' :
              'bg-gray-100 text-gray-800'
            }`}
          >
            Party: {leg.legislator_party}
          </span>

          {/* Vote totals */}
          <div className="mt-4 grid grid-cols-2 gap-4 text-gray-700">
            <div>
              <strong>Total Votes</strong>
              <div>{leg.total_votes}</div>
            </div>
            <div>
              <strong>Total Yea</strong>
              <div>{leg.total_yea}</div>
            </div>
            <div>
              <strong>Total Nay</strong>
              <div>{leg.total_nay}</div>
            </div>
            <div>
              <strong>Absent/NV</strong>
              <div>{leg.total_nv + leg.total_absent}</div>
            </div>
          </div>

          {/* Topics list with expandable bills */}
          <div className="mt-6">
            <h3 className="font-semibold mb-2 text-gray-800">Topics</h3>
            <div className="space-y-2">
              {Object.entries(leg.topicCounts).map(([topic, counts]) => (
                <div key={topic}>
                  <button
                    className="flex justify-between w-full text-left p-2 bg-gray-50 rounded"
                    onClick={() => setExpandedTopics(prev => ({ ...prev, [topic]: !prev[topic] }))}
                  >
                    <span className="font-medium text-gray-900 truncate">{topic}</span>
                    <span className="text-gray-500">{expandedTopics[topic] ? '➖' : '➕'}</span>
                  </button>

                  {expandedTopics[topic] && (
                    <div className="ml-4 mt-2 p-4 bg-gray-50 rounded">
                      {/* Topic aggregates */}
                      <div className="mb-4 grid grid-cols-2 gap-4 text-sm text-gray-600">
                        <div><strong>Yea:</strong> {counts.Yea}</div>
                        <div><strong>Nay:</strong> {counts.Nay}</div>
                        <div><strong>NV:</strong> {counts.NV}</div>
                        <div><strong>Absent:</strong> {counts.Absent}</div>
                      </div>
                      {/* Bills list */}
                      <div className="divide-y divide-gray-200">
                        {leg.bills
                          .filter(b =>
                            b.bill_topic.split(',').map(t => t.trim()).includes(topic)
                          )
                          .map(bill => (
                            <div key={bill.bill_id} className="py-3">
                              <a
                                href={bill.bill_link}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-blue-600 hover:underline block font-medium"
                                style={{
                                  display: '-webkit-box',
                                  WebkitLineClamp: 3,
                                  WebkitBoxOrient: 'vertical',
                                  overflow: 'hidden'
                                }}
                              >
                                {bill.bill_title}
                              </a>
                              <div className="mt-1 flex justify-between text-sm text-gray-500">
                                <span>Vote Cast: {bill.vote}</span>
                                <span>Vote Date: {bill.vote_date}</span>
                              </div>
                            </div>
                          ))}
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // Main dashboard component
    function VotesDashboard() {
      const [data, setData] = useState([]);
      const [searchText, setSearchText] = useState('');
      const [selectedParty, setSelectedParty] = useState('');
      const [expandAll, setExpandAll] = useState(false);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetch('votes.json')
          .then(res => res.json())
          .then(json => { setData(json); setLoading(false); })
          .catch(err => { console.error(err); setLoading(false); });
      }, []);

      const legislators = useMemo(() => {
        const map = {};
        data.forEach(row => {
          const key = row.legislator_name;
          if (!map[key]) map[key] = { ...row, bills: [], topicCounts: {}, total_votes: 0, total_yea: 0, total_nay: 0, total_nv: 0, total_absent: 0 };
          const leg = map[key];
          leg.total_votes++;
          if (row.vote === 'Yea') leg.total_yea++;
          else if (row.vote === 'Nay') leg.total_nay++;
          else if (row.vote === 'NV') leg.total_nv++;
          else if (row.vote === 'Absent') leg.total_absent++;
          const topics = row.bill_topic.split(',').map(t => t.trim());
          topics.forEach(topic => {
            if (!leg.topicCounts[topic]) leg.topicCounts[topic] = { Yea: 0, Nay: 0, NV: 0, Absent: 0 };
            leg.topicCounts[topic][row.vote]++;
          });
          leg.bills.push(row);
        });
        let list = Object.values(map);
        if (searchText) list = list.filter(l => l.legislator_name.toLowerCase().includes(searchText.toLowerCase()));
        if (selectedParty) list = list.filter(l => l.legislator_party === selectedParty);
        return list;
      }, [data, searchText, selectedParty]);

      const stats = useMemo(() => {
        const legislatorCount = new Set(data.map(r => r.legislator_name)).size;
        const billCount = data.length;
        const yeaCount = data.filter(r => r.vote === 'Yea').length;
        const nayCount = data.filter(r => r.vote === 'Nay').length;
        return {
          legislatorCount,
          billCount,
          yeaPercent: billCount ? 100 * yeaCount / billCount : 0,
          nayPercent: billCount ? 100 * nayCount / billCount : 0
        };
      }, [data]);

      return (
        <>
          <DashboardHeader controls={{ searchText, setSearchText, selectedParty, setSelectedParty, expandAll, setExpandAll, stats }} />
          {loading ? <Spinner /> : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {legislators.map(leg => <LegislatorCard key={leg.legislator_name} leg={leg} expandAll={expandAll} />)}
            </div>
          )}
        </>
      );
    }

    ReactDOM.render(<VotesDashboard />, document.getElementById('root'));
  </script>
</body>
</html>
