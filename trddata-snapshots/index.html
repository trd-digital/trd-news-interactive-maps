<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Real Estate Lookup Tool</title>
    <script src="https://static.therealdeal.com/library/theme.js?v=1.0"></script>
    <!-- Google Font: Merriweather -->
    <link
      href="https://static.therealdeal.com/ProximaNovaFontFamily/ProximaNova/proxima-nova-all.css"
      rel="stylesheet"
    />
    <style>
      /* 1) Light Mode (default) */
      :root {
        --primary-color: #000000; /* Black text */
        --secondary-color: #ffffff; /* White card background */
        --accent-color: #1e90ff; /* Dodger Blue */
        --text-color: #000000; /* Black for general text */
        --background-color: #f7f7f7; /* Light grayish background */
        --border-color: #cccccc; /* Light gray border */
        --hover-shadow: rgba(0, 0, 0, 0.1); /* Subtle shadow on hover */
      }
      /* 2) Dark Mode if OS/browser prefers dark */
      body[data-bs-theme="dark"] {
        --primary-color: #ffffff;
        --secondary-color: #1a1a1a;
        --accent-color: #1e90ff;
        --text-color: #ffffff;
        --background-color: #212121;
        --border-color: #333333;
        --hover-shadow: rgba(255, 255, 255, 0.2);
      }

      /* Global Styles */
      body {
        font-family: "Proxima Nova", serif;
        margin: 0;
        padding: 20px;
        background-image: url("images/blue-background.png");
        background-position: top center;
        background-repeat: no-repeat;
        background-color: var(--background-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
      }
      h1 {
        text-align: center;
        color: var(--secondary-color);
        margin-bottom: 30px;
        font-size: 3.6em;
        letter-spacing: 1px;
      }

      /* Filters Section */
      .filters {
        margin-bottom: 30px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
      }
      .filters input,
      .filters select,
      .filters button {
        padding: 8px 12px;
        border: 1px solid var(--secondary-color);
        border-radius: 5px;
        font-size: 0.9em;
        background-color: transparent;
        color: var(--secondary-color);
        transition: border-color 0.3s, box-shadow 0.3s;
      }
      .filters input::placeholder {
        color: var(--secondary-color);
      }
      .filters input:focus,
      .filters select:focus {
        border-color: var(--border-color);
        box-shadow: 0 0 5px var(--hover-shadow);
        outline: none;
      }
      .filters button {
        background-color: var(--accent-color);
        color: var(--secondary-color);
        border: 1px solid var(--secondary-color);
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        font-weight: bold;
      }
      .filters button:hover {
        background-color: #092e4d;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px var(--hover-shadow);
      }

      /* Prevent autofill background override (for Chrome/WebKit) */
      input:-webkit-autofill,
      input:-webkit-autofill:focus,
      input:-webkit-autofill:hover {
        -webkit-box-shadow: 0 0 0px 1000px var(--secondary-color) inset !important;
        -webkit-text-fill-color: var(--primary-color) !important;
      }

      /* Results Container */
      #resultsContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        align-items: start;
      }

      /* Group Card Styles */
      .group-card {
        background-color: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        position: relative;
        padding: 30px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .group-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
      }

      /* Group Header Styles */
      .group-header {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--accent-color);
        transition: background-color 0.3s;
      }
      .header-region {
        font-size: 1.1em;
        font-weight: 700;
        color: var(--primary-color);
        max-width: 100%;
        word-wrap: break-word;
      }
      .header-classification {
        font-size: 0.75em;
        color: var(--primary-color);
        max-width: 35%;
        text-align: right;
        word-wrap: break-word;
      }

      /* Group Details (Always Expanded) */
      .group-details {
        padding: 16px 0;
        display: flex !important;
        background-color: var(--secondary-color);
        flex-grow: 1;
        flex-direction: column;
        justify-content: flex-start;
      }

      /* Metrics List */
      .metrics-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .metrics-list li {
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .metrics-list li:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .metrics-title {
        font-weight: bold;
        color: var(--primary-color);
        font-size: 0.95em;
      }
      .metrics-value {
        color: var(--accent-color);
        font-size: 0.95em;
      }

      /* Submetrics */
      .submetrics {
        padding-top: 25px;
        font-size: 0.75em;
        color: var(--primary-color);
      }
      .submetrics div {
        margin-bottom: 4px;
      }

      /* Source Link */
      .source-entry {
        text-align: right;
        font-size: 0.55em;
        margin-top: -15px;
      }
      .source-entry a {
        text-decoration: none;
        color: var(--accent-color);
        font-weight: 500;
        transition: color 0.3s;
      }
      .source-entry a:hover {
        color: #1c86ee;
        text-decoration: underline;
      }

      /* Loading + Error Messages */
      #loadingIndicator,
      #errorMessage {
        text-align: center;
        padding: 20px;
        font-size: 1.1em;
        color: var(--primary-color);
      }
      #errorMessage {
        color: #ff6347;
      }

      /* Spinner */
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--accent-color);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 2s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Custom Date Filter Styles */
      #dateFilterContainer {
        position: relative;
        display: inline-block;
      }
      #dateFilterInput {
        cursor: pointer;
      }
      #dateFilterDropdown {
        position: absolute;
        top: 100%;
        left: 0;
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
        padding: 10px;
        display: none;
        z-index: 100;
        width: 200px;
      }

      /* Responsive Typography */
      @media (max-width: 768px) {
        .group-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .header-region {
          max-width: 100%;
        }
        .header-classification {
          margin-top: 6px;
          max-width: 100%;
          text-align: left;
        }
        .metrics-list li {
          margin-bottom: 10px;
          padding-bottom: 8px;
        }
        .metrics-title,
        .metrics-value {
          font-size: 0.9em;
        }
        .submetrics {
          font-size: 0.7em;
        }
        .source-entry {
          font-size: 0.7em;
          margin-top: 6px;
        }
        .filters {
          gap: 10px;
        }
        .filters input,
        .filters select,
        .filters button {
          padding: 6px 10px;
          font-size: 0.85em;
        }
      }
      #themeToggleBtn {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1;
        cursor: pointer;
        border-radius: 8px;
        border: none;
        background-color: var(--secondary-color);
      }
      #themeToggleBtn .text {
        display: none;
      }
      #themeToggleBtn .icon {
        pointer-events: none;
        display: inline-block;
        width: 25px;
        height: 25px;
        background-repeat: no-repeat;
        background-position: center;
        background-size: 50%;
        background-image: url("data:image/svg+xml,%3Csvg width='25' height='24' viewBox='0 0 25 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M22.2948 15.795C20.3964 16.5316 18.3247 16.7002 16.3322 16.2804C14.3396 15.8606 12.5121 14.8705 11.0722 13.4306C9.63235 11.9907 8.64221 10.1632 8.22241 8.17063C7.80261 6.17807 7.97125 4.10643 8.7078 2.20801C6.42746 3.09668 4.52898 4.75369 3.34016 6.89293C2.15133 9.03218 1.74678 11.5194 2.19634 13.9251C2.64591 16.3309 3.92137 18.5041 5.80252 20.0697C7.68367 21.6352 10.0524 22.4948 12.4998 22.5C14.6182 22.5006 16.6873 21.8605 18.4353 20.6639C20.1834 19.4673 21.5288 17.7701 22.2948 15.795Z' fill='black'/%3E%3C/svg%3E%0A");
      }

      [data-bs-theme="dark"] #themeToggleBtn .icon {
        filter: invert(1);
        background-size: 80%;
        background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M18 12C18 13.5913 17.3679 15.1174 16.2426 16.2426C15.1174 17.3679 13.5913 18 12 18C10.4087 18 8.88258 17.3679 7.75736 16.2426C6.63214 15.1174 6 13.5913 6 12C6 10.4087 6.63214 8.88258 7.75736 7.75736C8.88258 6.63214 10.4087 6 12 6C13.5913 6 15.1174 6.63214 16.2426 7.75736C17.3679 8.88258 18 10.4087 18 12ZM12.75 3.75C12.75 3.94891 12.671 4.13968 12.5303 4.28033C12.3897 4.42098 12.1989 4.5 12 4.5C11.8011 4.5 11.6103 4.42098 11.4697 4.28033C11.329 4.13968 11.25 3.94891 11.25 3.75C11.25 3.55109 11.329 3.36032 11.4697 3.21967C11.6103 3.07902 11.8011 3 12 3C12.1989 3 12.3897 3.07902 12.5303 3.21967C12.671 3.36032 12.75 3.55109 12.75 3.75ZM12.75 20.25C12.75 20.4489 12.671 20.6397 12.5303 20.7803C12.3897 20.921 12.1989 21 12 21C11.8011 21 11.6103 20.921 11.4697 20.7803C11.329 20.6397 11.25 20.4489 11.25 20.25C11.25 20.0511 11.329 19.8603 11.4697 19.7197C11.6103 19.579 11.8011 19.5 12 19.5C12.1989 19.5 12.3897 19.579 12.5303 19.7197C12.671 19.8603 12.75 20.0511 12.75 20.25ZM20.25 12.75C20.0511 12.75 19.8603 12.671 19.7197 12.5303C19.579 12.3897 19.5 12.1989 19.5 12C19.5 11.8011 19.579 11.6103 19.7197 11.4697C19.8603 11.329 20.0511 11.25 20.25 11.25C20.4489 11.25 20.6397 11.329 20.7803 11.4697C20.921 11.6103 21 11.8011 21 12C21 12.1989 20.921 12.3897 20.7803 12.5303C20.6397 12.671 20.4489 12.75 20.25 12.75ZM3.75 12.75C3.55109 12.75 3.36032 12.671 3.21967 12.5303C3.07902 12.3897 3 12.1989 3 12C3 11.8011 3.07902 11.6103 3.21967 11.4697C3.36032 11.329 3.55109 11.25 3.75 11.25C3.94891 11.25 4.13968 11.329 4.28033 11.4697C4.42098 11.6103 4.5 11.8011 4.5 12C4.5 12.1989 4.42098 12.3897 4.28033 12.5303C4.13968 12.671 3.94891 12.75 3.75 12.75ZM18.3645 6.696C18.2953 6.76763 18.2126 6.82477 18.1211 6.86408C18.0295 6.90338 17.9311 6.92407 17.8316 6.92494C17.732 6.9258 17.6332 6.90683 17.541 6.86912C17.4489 6.83141 17.3651 6.77572 17.2947 6.7053C17.2243 6.63488 17.1686 6.55114 17.1309 6.45897C17.0932 6.36679 17.0742 6.26803 17.0751 6.16845C17.0759 6.06886 17.0966 5.97045 17.1359 5.87895C17.1752 5.78744 17.2324 5.70468 17.304 5.6355C17.4455 5.49888 17.6349 5.42329 17.8316 5.42499C18.0282 5.4267 18.2163 5.50558 18.3554 5.64464C18.4944 5.78369 18.5733 5.9718 18.575 6.16845C18.5767 6.3651 18.5011 6.55455 18.3645 6.696ZM6.696 18.3645C6.62682 18.4361 6.54406 18.4933 6.45255 18.5326C6.36105 18.5719 6.26264 18.5926 6.16305 18.5934C6.06347 18.5943 5.96471 18.5753 5.87253 18.5376C5.78036 18.4999 5.69662 18.4442 5.6262 18.3738C5.55578 18.3034 5.50009 18.2196 5.46238 18.1275C5.42467 18.0353 5.4057 17.9365 5.40656 17.8369C5.40743 17.7374 5.42812 17.6389 5.46742 17.5474C5.50673 17.4559 5.56387 17.3732 5.6355 17.304C5.77695 17.1674 5.9664 17.0918 6.16305 17.0935C6.3597 17.0952 6.54781 17.1741 6.68686 17.3131C6.82592 17.4522 6.9048 17.6403 6.90651 17.8369C6.90821 18.0336 6.83262 18.223 6.696 18.3645ZM17.304 18.3645C17.2324 18.2953 17.1752 18.2126 17.1359 18.1211C17.0966 18.0295 17.0759 17.9311 17.0751 17.8316C17.0742 17.732 17.0932 17.6332 17.1309 17.541C17.1686 17.4489 17.2243 17.3651 17.2947 17.2947C17.3651 17.2243 17.4489 17.1686 17.541 17.1309C17.6332 17.0932 17.732 17.0742 17.8316 17.0751C17.9311 17.0759 18.0295 17.0966 18.1211 17.1359C18.2126 17.1752 18.2953 17.2324 18.3645 17.304C18.5011 17.4455 18.5767 17.6349 18.575 17.8316C18.5733 18.0282 18.4944 18.2163 18.3554 18.3554C18.2163 18.4944 18.0282 18.5733 17.8316 18.575C17.6349 18.5767 17.4455 18.5011 17.304 18.3645ZM5.6355 6.696C5.56387 6.62682 5.50673 6.54406 5.46742 6.45255C5.42812 6.36105 5.40743 6.26264 5.40656 6.16305C5.4057 6.06347 5.42467 5.96471 5.46238 5.87253C5.50009 5.78036 5.55578 5.69662 5.6262 5.6262C5.69662 5.55578 5.78036 5.50009 5.87253 5.46238C5.96471 5.42467 6.06347 5.4057 6.16305 5.40656C6.26264 5.40743 6.36105 5.42812 6.45255 5.46742C6.54406 5.50673 6.62682 5.56387 6.696 5.6355C6.83262 5.77695 6.90821 5.9664 6.90651 6.16305C6.9048 6.3597 6.82592 6.54781 6.68686 6.68686C6.54781 6.82592 6.3597 6.9048 6.16305 6.90651C5.9664 6.90821 5.77695 6.83262 5.6355 6.696Z' fill='black'/%3E%3C/svg%3E%0A");
      }
    </style>
  </head>
  <body data-bs-theme="light">
    <!-- Theme Toggle Button -->
    <button id="themeToggleBtn">
      <span class="text">Toggle Theme</span>
      <span class="icon"></span>
    </button>

    <h1>Real Estate Data Lookup</h1>

    <!-- Filters Section -->
    <div class="filters">
      <input type="text" id="searchRegion" placeholder="Search Region" />
      <select id="filterSector">
        <option value="">All Sectors</option>
        <!-- Options added dynamically -->
      </select>
      <!-- Custom Date Filter UI -->
      <div id="dateFilterContainer">
        <input
          type="text"
          id="dateFilterInput"
          readonly
          placeholder="Select Date Period(s)"
        />
        <div id="dateFilterDropdown">
          <div>
            <input
              type="radio"
              name="dpOption"
              id="radioMostRecent"
              value="most_recent"
              checked
            />
            <label for="radioMostRecent">Most Recent</label>
          </div>
          <div>
            <input
              type="radio"
              name="dpOption"
              id="radioSelect"
              value="select"
            />
            <label for="radioSelect">Select Dates</label>
          </div>
          <div
            id="checkboxContainer"
            style="margin-top: 10px; display: none"
          ></div>
          <button id="dateFilterApply" style="margin-top: 10px">Apply</button>
        </div>
      </div>
      <button id="resetFilters">Reset Filters</button>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" style="display: none">
      <div class="spinner"></div>
      <span>Loading data, please wait...</span>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" style="display: none">
      Failed to load data. Please
      <button
        id="retryButton"
        style="
          background: none;
          border: none;
          color: var(--accent-color);
          text-decoration: underline;
          cursor: pointer;
        "
      >
        try again</button
      >.
    </div>

    <!-- Results Container -->
    <div id="resultsContainer"><!-- Dynamically populated --></div>

    <!-- PapaParse Library -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"
      integrity="sha512-SGWgwwRA8xZgEoKiex3UubkSkV1zSE1BS6O4pXcaxcNtUlQsOmOmhVnDwIvqGRfEmuz83tIGL13cXMZn6upPyg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- JQuery AutoComplete -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- Theme Toggle Script -->
    <script>
      const trdTheme = TrdTheme();
      trdTheme.init();
      const toggleBtn = document.getElementById("themeToggleBtn");
      toggleBtn.addEventListener("click", trdTheme.toggle);
    </script>

    <!-- Data Fetching & Rendering Script -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const csvUrl = "TRD Data Snapshots - Snapshot2_0.csv"; // Replace with your CSV URL
        let data = [];

        const searchRegion = document.getElementById("searchRegion");
        const filterSector = document.getElementById("filterSector");
        const dateFilterInput = document.getElementById("dateFilterInput");
        const dateFilterDropdown =
          document.getElementById("dateFilterDropdown");
        const radioMostRecent = document.getElementById("radioMostRecent");
        const radioSelect = document.getElementById("radioSelect");
        const checkboxContainer = document.getElementById("checkboxContainer");
        const dateFilterApply = document.getElementById("dateFilterApply");
        const resetFilters = document.getElementById("resetFilters");
        const resultsContainer = document.getElementById("resultsContainer");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const errorMessage = document.getElementById("errorMessage");
        const retryButton = document.getElementById("retryButton");

        // Global custom order array (most recent first)
        const customOrder = [
          "Q1 2025",
          "Q4 2024",
          "Q3 2024",
          "Q2 2024",
          "Q1 2024",
          "Q4 2023",
        ];

        // Debounce function
        function debounce(func, delay) {
          let debounceTimer;
          return function () {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
          };
        }

        // Normalize CSV headers
        function normalizeHeaders(item) {
          const normalizedItem = {};
          for (let key in item) {
            const normalizedKey = key.trim().toLowerCase().replace(/\s+/g, "_");
            normalizedItem[normalizedKey] = item[key];
          }
          return normalizedItem;
        }

        // Extract hostname from URL
        function getHostname(url) {
          try {
            const hostname = new URL(url).hostname;
            return hostname.startsWith("www.") ? hostname.slice(4) : hostname;
          } catch (e) {
            console.error("Invalid URL:", url);
            return "Source";
          }
        }

        // Fetch CSV data
        function fetchData() {
          loadingIndicator.style.display = "block";
          Papa.parse(csvUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
              loadingIndicator.style.display = "none";
              data = results.data.map(normalizeHeaders);
              // console.log('Normalized Data:', data);
              if (data.length === 0) {
                console.error("CSV contains no data.");
                errorMessage.style.display = "block";
                return;
              }

              // After data is loaded, inside the PapaParse complete callback:
              const regions = [
                ...new Set(data.map((item) => item.region).filter(Boolean)),
              ].sort();
              $("#searchRegion").autocomplete({
                source: regions,
                select: function (event, ui) {
                  // Update the search input with the selected value
                  $("#searchRegion").val(ui.item.value);
                  // Trigger filtering automatically
                  filterData();
                },
              });

              populateFilters();
              // Set default values:
              searchRegion.value = "New York";
              // Default date filter input shows "Most Recent" (i.e. Q4 2024)
              dateFilterInput.value = customOrder[0];
              filterData();
            },
            error: function (err) {
              loadingIndicator.style.display = "none";
              console.error("Error loading CSV:", err);
              errorMessage.style.display = "block";
            },
          });
        }

        // Populate sector filter and set default for date filter input
        function populateFilters() {
          // Populate sector dropdown
          const sectors = [
            ...new Set(data.map((item) => item.sector).filter(Boolean)),
          ].sort();
          filterSector.innerHTML = '<option value="">All Sectors</option>';
          sectors.forEach((sector) => {
            const option = document.createElement("option");
            option.value = sector;
            option.textContent = sector;
            filterSector.appendChild(option);
          });
          // Set default for date filter input to "Most Recent"
          dateFilterInput.value = customOrder[0];
        }

        // Populate checkboxes for selecting multiple dates (include all dates)
        function populateCheckboxes() {
          checkboxContainer.innerHTML = "";
          customOrder.forEach((date) => {
            const wrapper = document.createElement("div");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.value = date;
            cb.id = "dp_" + date;
            const label = document.createElement("label");
            label.htmlFor = cb.id;
            label.textContent = date;
            wrapper.appendChild(cb);
            wrapper.appendChild(label);
            checkboxContainer.appendChild(wrapper);
          });
        }

        // Show/hide the custom dropdown when the date filter input is clicked
        dateFilterInput.addEventListener("click", () => {
          dateFilterDropdown.style.display = "block";
        });

        // Radio button change events
        radioMostRecent.addEventListener("change", () => {
          if (radioMostRecent.checked) {
            checkboxContainer.style.display = "none";
          }
        });
        radioSelect.addEventListener("change", () => {
          if (radioSelect.checked) {
            checkboxContainer.style.display = "block";
            populateCheckboxes();
          }
        });

        // When "Apply" is clicked, update the date filter input and trigger filtering
        dateFilterApply.addEventListener("click", () => {
          let selectedDates;
          if (radioMostRecent.checked) {
            selectedDates = [customOrder[0]];
          } else {
            selectedDates = Array.from(
              checkboxContainer.querySelectorAll(
                "input[type='checkbox']:checked"
              )
            ).map((cb) => cb.value);
            // If none are selected, default back to most recent
            if (selectedDates.length === 0) {
              selectedDates = [customOrder[0]];
              radioMostRecent.checked = true;
              checkboxContainer.style.display = "none";
            }
          }
          dateFilterInput.value = selectedDates.join(", ");
          dateFilterDropdown.style.display = "none";
          filterData();
        });

        // Filter data based on user input
        function filterData() {
          const reg = searchRegion.value.trim().toLowerCase();
          const sec = filterSector.value;
          let effectiveDates;
          // Determine effective dates from the dateFilterInput value.
          if (dateFilterInput.value === customOrder[0]) {
            effectiveDates = [customOrder[0]];
          } else {
            effectiveDates = dateFilterInput.value.split(", ").filter((v) => v);
          }
          const newData = data.filter((item) => {
            const matchesRegion =
              reg === "" ||
              (item.region && item.region.toLowerCase().includes(reg));
            const matchesSector = sec === "" || item.sector === sec;
            const matchesDate =
              effectiveDates.length === 0 ||
              effectiveDates.includes(item.date_period);
            return matchesRegion && matchesSector && matchesDate;
          });
          displayGroupedResults(newData);
        }

        // Group data based on several keys, and include ranking_priority from the CSV
        function groupData(dataArray) {
          const groups = {};
          dataArray.forEach((item) => {
            const groupKey = `
            ${item.sector || "N/A"}|
            ${item.region || "N/A"}|
            ${item.last_updated || "N/A"}|
            ${item.date_period || "N/A"}|
            ${item.source_link || "N/A"}
          `.trim();
            if (!groups[groupKey]) {
              groups[groupKey] = {
                sector: item.sector || "N/A",
                region: item.region || "N/A",
                last_updated: item.last_updated || "N/A",
                date_period: item.date_period || "N/A",
                source_link: item.source_link || "N/A",
                source: item.source || "N/A",
                // Store ranking_priority (assuming it's numeric; if not, convert to int)
                ranking_priority: parseInt(item.ranking_priority, 10) || 0,
                entries: [],
              };
            }
            groups[groupKey].entries.push({
              display_title: item.display_title || "N/A",
              value: item.value || "N/A",
            });
          });
          return Object.values(groups);
        }

        // Validate URL
        function isValidURL(str) {
          try {
            new URL(str);
            return true;
          } catch (_) {
            return false;
          }
        }

        // Display grouped results (cards are always expanded)
        function displayGroupedResults(dataToDisplay) {
          resultsContainer.innerHTML = "";
          if (dataToDisplay.length === 0) {
            const noDataDiv = document.createElement("div");
            noDataDiv.textContent = "No results found.";
            noDataDiv.style.textAlign = "center";
            noDataDiv.style.padding = "20px";
            resultsContainer.appendChild(noDataDiv);
            return;
          }
          let grouped = groupData(dataToDisplay);

          // Sort groups: first by ranking_priority (1 before 0), then by date period order
          grouped.sort((a, b) => {
            if (b.ranking_priority !== a.ranking_priority) {
              return b.ranking_priority - a.ranking_priority;
            } else {
              return (
                customOrder.indexOf(a.date_period) -
                customOrder.indexOf(b.date_period)
              );
            }
          });

          // Optionally limit groups if not using the full range (here we only slice if the date filter is not most recent)
          // if(dateFilterInput.value !== customOrder[0]){
          //   grouped = grouped.slice(0, 12);
          // }
          // Limit the number of results to 20
          grouped = grouped.slice(0, 20);

          // console.log('Grouped Data:', grouped);

          // Define metrics for Residential vs. Commercial
          const residentialMetrics = [
            "Median Sale Price",
            "Median Price Per Sq. Ft.",
            "Number of Sales",
            "Median Days on Market",
            "Listing Inventory",
            "Months of Supply",
          ];
          const commercialMetrics = [
            "Vacancy Rate",
            "Asking psf",
            "Absorption",
            "Inventory",
            "Deliveries YTD",
            "Under Construction",
          ];

          const resiConstructionMetrics = [
            "Single-Family Home",
            "Two-Family Home",
            "Three- and Four-Family Buildings",
            "Five-or-More Family Buildings",
            "Total Family Buildings",
          ];

          grouped.forEach((group) => {
            const card = document.createElement("div");
            card.classList.add("group-card");

            // Header (static)
            const header = document.createElement("div");
            header.classList.add("group-header");
            header.innerHTML = `
            <div class="header-region">
              ${
                group.region !== "N/A"
                  ? `<span>${group.region}</span>`
                  : `<span>N/A</span>`
              }
            </div>
          `;
            card.appendChild(header);

            // Details (always visible)
            const details = document.createElement("div");
            details.classList.add("group-details");

            // Choose metrics based on sector
            let metricsToDisplay = residentialMetrics;
            if (group.sector && group.sector.toLowerCase() === "office") {
              metricsToDisplay = commercialMetrics;
            }

            if (
              group.sector &&
              group.sector.toLowerCase() === "residential construction"
            ) {
              metricsToDisplay = resiConstructionMetrics;
            }

            // Build metrics list
            const metricsList = document.createElement("ul");
            metricsList.classList.add("metrics-list");
            metricsToDisplay.forEach((metricTitle) => {
              const li = document.createElement("li");
              const foundEntry = group.entries.find(
                (e) =>
                  e.display_title &&
                  e.display_title.toLowerCase() === metricTitle.toLowerCase()
              );
              const val = foundEntry ? foundEntry.value : "N/A";
              li.innerHTML = `
              <div class="metrics-title">${metricTitle}:</div>
              <div class="metrics-value">${val}</div>
            `;
              metricsList.appendChild(li);
            });
            details.appendChild(metricsList);

            // Submetrics (Last Updated, Date Period)
            const submetrics = document.createElement("div");
            submetrics.classList.add("submetrics");
            const lu =
              group.last_updated !== "N/A" ? group.last_updated : "N/A";
            const dp = group.date_period !== "N/A" ? group.date_period : "N/A";
            submetrics.innerHTML = `
            <div><strong>Last Updated:</strong> ${lu}</div>
            <div><strong>Date Period:</strong> ${dp}</div>
          `;
            details.appendChild(submetrics);

            // Source link
            if (group.source_link !== "N/A" && isValidURL(group.source_link)) {
              const sourceDiv = document.createElement("div");
              sourceDiv.classList.add("source-entry");
              let linkText =
                group.source && group.source !== "N/A"
                  ? group.source
                  : getHostname(group.source_link);
              sourceDiv.innerHTML = `<a href="${group.source_link}" target="_blank">${linkText}</a>`;
              details.appendChild(sourceDiv);
            }
            card.appendChild(details);
            resultsContainer.appendChild(card);
          });
        }

        // Reset filters function
        function resetAllFilters() {
          searchRegion.value = "";
          filterSector.value = "";
          dateFilterInput.value = customOrder[0];
          radioMostRecent.checked = true;
          checkboxContainer.style.display = "none";
          displayGroupedResults(data);
        }

        // Initialize
        fetchData();

        // Event Listeners for dynamic filtering
        searchRegion.addEventListener("input", debounce(filterData, 300));
        filterSector.addEventListener("change", filterData);
        // The custom date filter calls filterData() when "Apply" is clicked.
        resetFilters.addEventListener("click", resetAllFilters);
        retryButton &&
          retryButton.addEventListener("click", () => {
            errorMessage.style.display = "none";
            fetchData();
          });
      });
    </script>
  </body>
</html>
