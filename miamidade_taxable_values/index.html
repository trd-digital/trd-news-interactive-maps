<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Taxable Values Dashboard</title>

  <!-- Leaflet CSS (integrity attributes removed) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #controls {
      margin-bottom: 20px;
    }

    #cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
    }

    .card h3 {
      margin-top: 0;
      font-size: 1.1em;
    }

    .card p {
      margin: 5px 0;
      font-size: 1em;
    }

    label {
      font-weight: bold;
      margin-right: 10px;
    }

    select {
      padding: 5px;
      font-size: 1em;
    }

    #map {
      width: 100%;
      height: 500px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <div id="controls">
    <label for="authoritySelect">Select Taxing Authority:</label>
    <select id="authoritySelect"></select>
  </div>

  <div id="cards"></div>

  <div id="map"></div>

  <!-- Leaflet JS (integrity attributes removed) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    let geoJsonData = null;
    let map, geoJsonLayer, highlightLayer;

    // 1) Initialize on DOMContentLoaded
    document.addEventListener("DOMContentLoaded", () => {
      initializeMap();
      loadGeoJsonAndPopulate();
    });

    // 2) Initialize the Leaflet map (no data yet)
    function initializeMap() {
      // Default center/zoom if nothing is selected
      map = L.map("map").setView([27.7, -81.9], 7);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution:
          '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
      }).addTo(map);

      geoJsonLayer = L.geoJSON(null, {
        style: {
          color: "#3388ff",
          weight: 1,
          fillOpacity: 0.2,
        },
      }).addTo(map);

      highlightLayer = L.geoJSON(null, {
        style: {
          color: "#ff0000",
          weight: 2,
          fillOpacity: 0.3,
        },
      }).addTo(map);
    }

    // 3) Load the merged GeoJSON, populate dropdown, add all features in base layer
    function loadGeoJsonAndPopulate() {
      fetch("merged_taxable_values.geojson")
        .then((resp) => resp.json())
        .then((geojson) => {
          geoJsonData = geojson;

          // Add every feature to the base layer
          geoJsonLayer.addData(geoJsonData);

          // Build dropdown from each feature's "TAXING AUTHORITY" property
          const selectEl = document.getElementById("authoritySelect");
          geoJsonData.features.forEach((feat) => {
            const authorityName = feat.properties["TAXING AUTHORITY"];
            const opt = document.createElement("option");
            opt.value = authorityName;
            opt.textContent = authorityName;
            selectEl.appendChild(opt);
          });

          // When the user picks a new authority, update cards + map
          selectEl.addEventListener("change", () => {
            updateCards(selectEl.value);
            updateMap(selectEl.value);
          });

          // Initialize with the first feature in the list
          if (geoJsonData.features.length > 0) {
            const firstAuthority =
              geoJsonData.features[0].properties["TAXING AUTHORITY"];
            selectEl.value = firstAuthority;
            updateCards(firstAuthority);
            updateMap(firstAuthority);
          }
        })
        .catch((err) => {
          console.error("Error loading GeoJSON:", err);
        });
    }

    // 4) Update the card UI using properties from the selected feature
    function updateCards(selectedAuthority) {
      if (!geoJsonData) return;

      // Find the matching feature in geoJsonData
      const feat = geoJsonData.features.find(
        (f) => f.properties["TAXING AUTHORITY"] === selectedAuthority
      );
      if (!feat) return;

      const props = feat.properties;
      const cardsContainer = document.getElementById("cards");
      cardsContainer.innerHTML = "";

      const fields = [
        {
          label: "2024 Preliminary Value",
          key: "2024 PRELIMINARY TAXABLE VALUE",
        },
        {
          label: "2025 Before New Construction",
          key: "2025 ESTIMATED TAXABLE VALUE BEFORE NEW CONSTRUCTION",
        },
        {
          label: "Percent Change",
          key: "PERCENT CHANGE",
          isPercent: true,
        },
        { label: "New Construction", key: "NEW CONSTRUCTION" },
        { label: "2025 June 1 Estimate", key: "2025 JUNE 1ST ESTIMATE" },
        {
          label: "Percent Change From 2024",
          key: "PERCENT CHANGE FROM 2024",
          isPercent: true,
        },
        { label: "Net Change", key: "NET VALUE CHANGE" },
      ];

      fields.forEach((f) => {
        const card = document.createElement("div");
        card.className = "card";

        const title = document.createElement("h3");
        title.textContent = f.label;

        const valueEl = document.createElement("p");
        let rawVal = props[f.key];

        if (rawVal === null || rawVal === undefined) {
          valueEl.textContent = "N/A";
        } else if (f.isPercent) {
          // rawVal is a string like "9.8%", so display as-is
          valueEl.textContent = rawVal;
        } else {
          // rawVal is numeric or numeric-string; ensure number
          const num = typeof rawVal === "string" ? Number(rawVal) : rawVal;
          valueEl.textContent = "$" + formatLargeNumber(num);
        }

        card.appendChild(title);
        card.appendChild(valueEl);
        cardsContainer.appendChild(card);
      });
    }

    // 5) Highlight & zoom the map to the selected feature
    function updateMap(selectedAuthority) {
      if (!geoJsonData) return;

      highlightLayer.clearLayers();

      // Find the matching feature
      const feat = geoJsonData.features.find(
        (f) => f.properties["TAXING AUTHORITY"] === selectedAuthority
      );
      if (!feat) {
        // No geometry: reset to default view
        map.setView([27.7, -81.9], 7);
        return;
      }

      // Add to highlight layer
      highlightLayer.addData(feat);

      // Compute bounds and fit
      const tempLayer = L.geoJSON(feat);
      map.fitBounds(tempLayer.getBounds().pad(0.25), {
        animate: true,
        duration: 0.5,
      });
    }

    // 6) Helper: condense large numbers into M/B
    function formatLargeNumber(num) {
      const absNum = Math.abs(num);
      if (absNum >= 1e9) {
        return (num / 1e9).toFixed(1) + "B";
      }
      if (absNum >= 1e6) {
        return (num / 1e6).toFixed(1) + "M";
      }
      return num.toLocaleString("en-US");
    }
  </script>
</body>
</html>
