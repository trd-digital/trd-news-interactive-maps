<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
		<meta name="robots" content="noindex, nofollow" />
		<title>South Florida Transactions — Map & Table</title>
		<link rel="icon" type="image/x-icon" href="https://therealdeal.com/favicon.ico" />
		<link rel="canonical" href="https://therealdeal.com/data/" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="true" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@0,400;0,700;0,900&display=swap" />
		<link rel="stylesheet" href="https://static.therealdeal.com/ProximaNovaFontFamily/ProximaNova/proxima-nova-all.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" />
		<link rel="stylesheet" href="../trd-data/common-map/map.css" />
		<link rel="stylesheet" href="../trd-data/common-table/table.css" />
		<!-- Google Tag Manager -->
		<script>
			// State helpers: persist to URL and localStorage
			const STATE_KEYS = ['county','search','sortName','sortOrder','sortPriority','pageSize','pageNumber'];
			function getState(){
				const params = new URLSearchParams(location.search);
				const s = {};
				STATE_KEYS.forEach(k => { if (params.has(k)) s[k] = params.get(k); });
				try { const ls = JSON.parse(localStorage.getItem('sf-transactions-state')||'{}'); return { ...ls, ...s }; } catch(_) { return s; }
			}
			function setState(part){
				const prev = getState(); const next = { ...prev, ...part };
				try { localStorage.setItem('sf-transactions-state', JSON.stringify(next)); } catch(_){}
				const params = new URLSearchParams(location.search);
				Object.entries(next).forEach(([k,v])=>{ if (v===undefined||v===null||v==='') params.delete(k); else params.set(k, Array.isArray(v)?JSON.stringify(v):v); });
				history.replaceState(null, '', `${location.pathname}?${params.toString()}`);
			}
			(function (w, d, s, l, i) {
				w[l] = w[l] || [];
				w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
				var f = d.getElementsByTagName(s)[0],
					j = d.createElement(s),
					dl = l != "dataLayer" ? "&l=" + l : "";
				j.async = true;
				j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
				f.parentNode.insertBefore(j, f);
			})(window, document, "script", "dataLayer", "GTM-K694XL6");
		</script>
		<!-- End Google Tag Manager -->
		<style>
			/* Increase top offset so content clears the fixed navbar */
			main { margin-top: 80px; }
			/* Mapbox needs an explicit height, not just min-height */
			.map-height { height: 75vh; }
			/* Highlight matching table rows */
			.table-row-highlight { background-color: rgba(255, 235, 59, 0.3); }
			/* Keep map interactions unobstructed without breaking popups */
			#map { position: relative; }
			#legend, #result { pointer-events: none; }
			/* Temporary highlight marker */
			.search-highlight-marker { width: 24px; height: 24px; border-radius: 50%; box-shadow: 0 0 0 6px rgba(255, 87, 34, 0.3); background-color: #FF5722; opacity: 0.85; border: 2px solid #FFF; animation: pulse 1.5s ease-in-out infinite; }
			@keyframes pulse { 0% { box-shadow: 0 0 0 4px rgba(255,87,34,0.25); } 50% { box-shadow: 0 0 0 10px rgba(255,87,34,0.15); } 100% { box-shadow: 0 0 0 4px rgba(255,87,34,0.25); } }

			/* Override repeating sort indicator backgrounds from table.css (stronger selectors) */
			.bootstrap-table .fixed-table-header thead th,
			.bootstrap-table .table thead th,
			.header-style,
			.header-style .th-inner { background-image: none !important; }
			/* Remove pseudo-arrow decorations inserted by some themes */
			.bootstrap-table .table thead th .th-inner::before,
			.bootstrap-table .table thead th .th-inner::after,
			.header-style .th-inner::before,
			.header-style .th-inner::after { content: none !important; display: none !important; }
			/* Hide default text-based order arrows to rely on Bootstrap Icons */
			.bootstrap-table .table thead th .order,
			.header-style .sortable .order { display: none !important; }

			/* Completely remove any sort arrows/icons in headers, regardless of source */
			.header-style .th-inner i,
			.header-style .th-inner svg,
			.bootstrap-table .table thead th i,
			.bootstrap-table .table thead th svg { display: none !important; }
			/* Remove possible background patterns on inner container */
			.header-style .th-inner,
			.bootstrap-table .table thead th .th-inner { background: none !important; }
			/* Remove additional indicators from Bootstrap Table classes */
			.bootstrap-table .table thead th .bootstrap-table-sort-icon,
			.bootstrap-table .table thead th .sort-priority,
			.bootstrap-table .fixed-table-header thead th .bootstrap-table-sort-icon { display: none !important; }

			/* Search suggestions dropdown */
			.navbar .input-group { position: relative; }
			#search-suggestions { position: absolute; top: 100%; left: 0; right: 0; z-index: 1050; max-height: 300px; overflow-y: auto; }
			#search-suggestions .dropdown-item small { color: #6c757d; }
			/* Compact background around navbar controls (subtle on black banner) */
			.navbar-controls { background-color: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; }
			/* Brand pill on black banner */
			.brand-pill { background-color: transparent; border: none; border-radius: 8px; padding: 4px 8px; color: #fff; }
		</style>
	</head>
	<body>
		<!-- Google Tag Manager (noscript) -->
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K694XL6" height="0" width="0" style="display: none; visibility: hidden"></iframe></noscript>
		<!-- End Google Tag Manager (noscript) -->
		<nav class="navbar fixed-top navbar-dark border-bottom" style="background-color: #000;">
			<div class="container-fluid">
			<span class="navbar-brand mb-0 h6 brand-pill">South Florida Transactions</span>
				<div class="navbar-controls d-flex align-items-center gap-2 px-2 py-2">
					<div class="input-group input-group-sm" style="width: 320px;">
						<input id="global-search" type="text" class="form-control" placeholder="Search address, folio, seller, buyer" />
						<div id="search-suggestions" class="dropdown-menu"></div>
					</div>
					<div class="input-group input-group-sm" style="width: 220px;">
						<span class="input-group-text"><i class="bi bi-geo"></i></span>
						<select id="county-filter" class="form-select">
							<option value="All">All Counties</option>
							<option value="Miami-Dade">Miami-Dade</option>
							<option value="Palm Beach">Palm Beach</option>
							<option value="Broward">Broward</option>
						</select>
					</div>
				</div>
			</div>
		</nav>
		<main class="container-fluid py-3">
			<!-- Map Section (full width) -->
			<div class="card mb-3">
				<div class="card-header">South Florida Transactions Map</div>
				<div class="card-body">
					<section id="map" class="map map-height"></section>
					<!-- Map filters UI will be auto-created by map.js -->
					<!-- Optional: legend container used by map.js -->
					<div id="legend" class="mt-2"></div>
					<div id="result" class="mt-2"></div>
				</div>
			</div>

			<!-- Table Section (full width) -->
			<div id="table-collapse">
			<div class="card">
				<div class="card-header d-flex justify-content-between align-items-center">
					<span>South Florida Sales Table</span>
					<div id="table-toolbar" class="d-flex gap-2"></div>
				</div>
				<div class="card-body">
					<table id="table"></table>
				</div>
			</div>
			</div>
		</main>

		<!-- Custom Multi Sort Modal (Bootstrap 5 native) -->
		<div class="modal fade" id="multiSortModal" tabindex="-1" aria-labelledby="multiSortModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-scrollable">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="multiSortModalLabel">Multi-column Sort</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div id="multi-sort-rows" class="d-flex flex-column gap-2"></div>
						<div class="mt-3">
							<button id="add-sort-row" type="button" class="btn btn-sm btn-outline-secondary">
								<i class="bi bi-plus-circle"></i> Add Sort Rule
							</button>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
						<button id="apply-multi-sort" type="button" class="btn btn-primary">Apply Sort</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Core libs -->
		<script src="https://experience.tinypass.com/xbuilder/experience/load?aid=p7sVIGTDn5"></script>
		<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<!-- Bootstrap Table -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.2/dist/bootstrap-table.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.2/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.2/dist/extensions/multiple-sort/bootstrap-table-multiple-sort.min.js"></script>
		<!-- Mapbox GL -->
		<script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
		<!-- TRD shared -->
		<script src="https://static.therealdeal.com/library/theme.js?v=1.0"></script>
		<script src="../trd-data/common-formatter/formatter.js"></script>
		<script src="../trd-data/common-loading/loading.js"></script>
		<script src="../trd-data/common-map/map.js?v=1.1"></script>
		<!-- Note: omit common-table/table.js to avoid global conflicts with map.js -->

		<script>
			// Shared constants/config
			const filePaths = [
				"miami_dade_output.geojson",
				"palm_beach_output.geojson",
				"broward_output.geojson",
			];

			const legendKeys = [
				{
					title: "Sales",
					options: [
						{ value: 100_000, color: { light: "#90CAF9", dark: "#90CAF9" }, text: "< $500K", default: false },
						{ value: 750_000, color: { light: "#42A5F5", dark: "#42A5F5" }, text: "$500K - $750K", default: false },
						{ value: 1_000_000, color: { light: "#1E88E5", dark: "#1E88E5" }, text: "$750K - $1M", default: false },
						{ value: 5_000_000, color: { light: "#1565C0", dark: "#1565C0" }, text: "$1M - $5M", default: false },
						{ value: 10_000_000, color: { light: "#0D47A1", dark: "#0D47A1" }, text: "> $10M", default: true },
					],
				},
				{
					title: "Mortgage",
					options: [
						{ value: "mortgage", color: { light: "#FF9800", dark: "#FF9800" }, text: "Orange stroke = Mortgage", default: false, isStroke: true },
					],
				},
			];

			const tooltipDisplayFields = {
				title: { field: "Physical Address", label: "Address" },
				content: [
					{ field: "Sale Price", label: "Sale Price", format: "formatPrice" },
					{ field: "Loan Amount", label: "Loan Amount", format: "formatPrice" },
					{ field: "Description", label: "Use Code" },
					{ field: "Record Date", label: "Record Date", format: "formatDate" },
				],
			};

			const modalDisplayFields = {
				title: { field: "Physical Address", label: "Address" },
				content: [
					{ field: "Doc Type", label: "Doc Type" },
					{ field: "Seller", label: "Seller" },
					{ field: "Buyer", label: "Buyer" },
					{ field: "Sale Price", label: "Sale Price", format: "formatPrice" },
					{ field: "Loan Amount", label: "Loan Amount", format: "formatPrice" },
					{ field: "Record Date", label: "Record Date", format: "formatDate" },
					{ field: "Folio", label: "Folio" },
					{ field: "Description", label: "Use Code Description" },
					{ field: "Acres", label: "Lot Size" },
					{ field: "Previous Owner Name", label: "Previous Owner Name" },
					{ field: "Previous Sale Price", label: "Previous Sale Price" },
				],
			};

			const fetchDataFilterCallback = (data) => {
				return {
					...data,
					features: data.features.map((feature) => ({
						...feature,
						properties: {
							...feature.properties,
							"Use Code Description": feature.properties["Description"] || null,
							"Sale Price": TrdFormatters.getNumberValue(
								feature.properties["Sale Price"] || feature.properties["Consideration"] || null
							),
							"Loan Amount": TrdFormatters.getNumberValue(feature.properties["Loan Amount"] || null),
							"Previous Sale Date": feature.properties["Previous Sale Date"] || feature.properties["Date of Previous Sale"] || null,
						},
					})),
				};
			};

			// Init Map
			window.map = trdDataCommonMap({
				filePaths,
				fileAddKeyValues: [
					{ County: "Miami-Dade" },
					{ County: "Palm Beach" },
					{ County: "Broward" },
				],
				eventCategory: "south-florida-transactions-map",
				mapElementId: "map",
				// Remove built-in map filter UI; use top toolbar dropdown instead
				filterElementId: null,
				legendElementId: "legend",
				resultElementId: "result",
				mapCenterLat: 26.380126753919782,
				mapCenterLng: -80.38513016032842,
				zoom: 8,
				minZoom: 8,
				legendKeys,
				dataPointKeys: legendKeys[0].options,
				tooltipDisplayFields,
				modalDisplayFields,
				fetchDataFilterCallback,
				loadingEnabled: true,
				mapLayerPaint: {
					'circle-stroke-width': [
						"case",
						[">", ["to-number", ["get", "Loan Amount"], 0], 0],
						2,
						0
					],
					'circle-stroke-color': "#FF9800",
				},
				pointSettings: {
					clickToCenter: true,
					clickToZoom: true,
					colorType: "step",
					radiusType: "radius",
					colorTypeDataKey: "Sale Price",
					paintSettings: {
						hover: { color: { light: "#FF9800", dark: "#F57C00" } },
						active: { color: { light: "#FF5722", dark: "#D84315" } },
						default: { radius: 4 },
					},
				},
				// Disable built-in map search UI (magnifying glass)
				searchSettings: {
					enable: false,
					placeholderText: "Search by address, folio, seller, buyer...",
					resultTitleField: "Address",
					searchFields: ["Address", "Folio", "Buyer", "Seller"],
				},
				// Disable built-in filter selector; filtering controlled by toolbar dropdown
				filterFields: [],
			});

			// Table columns
			const displayColumns = [
				{ dataField: "Physical Address", name: "Address", visible: true },
				{ dataField: "Sale Price", name: "Sale Price", visible: true, formatter: TrdFormatters.formatPrice, sortable: true },
				{ dataField: "Loan Amount", name: "Loan Amount", visible: true, formatter: TrdFormatters.formatPrice, sortable: true },
				{ dataField: "Record Date", name: "Record Date", visible: true, formatter: TrdFormatters.formatDate, sorter: TrdSorters.sortDate, sortable: true },
				{ dataField: "Use Code Description", name: "Description", visible: true, sortable: true },
				{ dataField: "Seller", name: "Seller", visible: true, sortable: true },
				{ dataField: "Buyer", name: "Buyer", visible: true, sortable: true },
				{ dataField: "County", name: "County", visible: true, sortable: true },
				{ dataField: "Doc Type", name: "Doc Type", visible: false },
				{ dataField: "Folio", name: "Folio", visible: false },
				{ dataField: "Previous Owner Name", name: "Previous Owner Name", visible: false },
				{ dataField: "Previous Sale Price", name: "Previous Sale Price", visible: false },
			];

			const tableFilterCallback = (data) => {
				return new Promise((resolve) => {
					const filteredData = data.features.map((item, _i) => ({
						...item.properties,
						"Use Code Description": item.properties["Description"] || null,
						"Sale Price": TrdFormatters.getNumberValue(
							item.properties["Sale Price"] || item.properties["Consideration"] || null
						),
						"Loan Amount": TrdFormatters.getNumberValue(item.properties["Loan Amount"] || null),
						"Previous Sale Date": item.properties["Previous Sale Date"] || item.properties["Date of Previous Sale"] || null,
					}));
					resolve(filteredData);
				});
			};

			// Init Table without common-table wrapper to avoid conflicts
			(async function initTable(){
				const tableEl = document.getElementById('table');
				const initialState = getState();
				const COUNTY_FIELD = TrdFormatters.getFieldName('County');

				const fetchFile = (path, county) => fetch(path)
					.then(r => r.json())
					.then(data => {
						const features = data.features.map(f => ({
							...f,
							properties: {
								...f.properties,
								County: county,
								__coords: (f.geometry && f.geometry.coordinates) || null
							}
						}));
						return tableFilterCallback({ features });
					});

				const results = await Promise.all([
					fetchFile(filePaths[0], 'Miami-Dade'),
					fetchFile(filePaths[1], 'Palm Beach'),
					fetchFile(filePaths[2], 'Broward')
				]);
				{
					// results are arrays of raw property objects; normalize keys to match column field names
					const rows = ([]).concat(...results).map((item) => {
						const row = {};
						// include County for filtering
						row[TrdFormatters.getFieldName('County')] = item['County'];
						// include coordinates for map zooming on search
						row['__coords'] = item['__coords'] || null;
						displayColumns.forEach((dc) => {
							const sourceKey = dc.dataField;
							const fieldName = TrdFormatters.getFieldName(sourceKey);
							row[fieldName] = item[sourceKey];
						});
						return row;
					});
					// persist original full dataset for county filtering
					window.originalRows = rows.slice();
					const columns = displayColumns.map(dc => ({
						field: TrdFormatters.getFieldName(dc.dataField),
						title: dc.name || dc.dataField,
						visible: dc.visible ? true : false,
						sortable: dc.sortable === true,
						formatter: dc.formatter || TrdFormatters.formatterValue,
						sorter: dc.sorter,
					}));

					$(tableEl).bootstrapTable({
						toolbar: '#table-toolbar',
						columns,
						data: rows,
						sortable: true,
						multipleSort: true,
						search: true,
						searchSelector: '#global-search',
						searchHighlight: true,
						iconsPrefix: 'bi',
						buttonsPrefix: 'btn',
						buttonsClass: 'btn btn-sm btn-outline-secondary',
						icons: { sortAscending: 'bi bi-arrow-up-short', sortDescending: 'bi bi-arrow-down-short', detailOpen: 'bi bi-chevron-down', detailClose: 'bi bi-chevron-up', multipleSort: 'bi bi-sliders' },
						sortName: initialState.sortName || TrdFormatters.getFieldName('Record Date'),
						sortOrder: initialState.sortOrder || 'desc',
						sortStable: true,
						sortResetPage: true,
						pagination: true,
						paginationVAlign: 'both',
						pageList: [10, 50, 100],
						pageSize: initialState.pageSize ? parseInt(initialState.pageSize,10) : 10,
						classes: 'table table-responsive',
						theadClasses: 'header-style',
						detailView: true,
						detailFormatter: function(index, row){
							const half = Math.ceil(displayColumns.length / 2);
							const left = displayColumns.slice(0, half);
							const right = displayColumns.slice(half);
							const mapDetailRow = (displayColumn) => {
								const key = TrdFormatters.getFieldName(displayColumn.dataField);
								const value = row[key];
								if (TrdFormatters.isEmptyValue(value)) return '';
								const formattedValue = displayColumn.formatter ? displayColumn.formatter(value) : TrdFormatters.formatterValue(value);
								return `<div class="row my-2 pb-2 border-bottom"><div class="text-capitalize col-4"><strong>${displayColumn.name}:</strong></div><div class="col-8">${formattedValue}</div></div>`;
							};
							return `<div class="container"><div class="row my-5"><div class="col-12 col-md-6"><table class="table table-sm"><tbody>${left.map(mapDetailRow).join('')}</tbody></table></div><div class="col-12 col-md-6"><table class="table table-sm"><tbody>${right.map(mapDetailRow).join('')}</tbody></table></div></div></div>`;
						},
						icons: { detailOpen: 'bi bi-chevron-down', detailClose: 'bi bi-chevron-up' },
						showColumns: true,
						showColumnsToggleAll: true,
						minimumCountColumns: 2,
						stickyHeader: true,
						stickyHeaderOffsetY: 56,
						stickyHeaderOffsetLeft: parseInt($('body').css('padding-left'), 10),
						stickyHeaderOffsetRight: parseInt($('body').css('padding-right'), 10),
						onSort: (name, order) => {
							document.querySelectorAll('.header-style .sorted').forEach((h)=>h.classList.remove('sorted'));
							const header = document.querySelector(`[data-field="${name}"]`);
							if (header) header.classList.add('sorted');
						},
						onPostHeader: () => {
							document.querySelectorAll('.header-style .sortable.desc, .header-style .sortable.asc').forEach((h)=>{ h.parentNode.classList.add('sorted'); });
						},
						showMultiSort: true,
						showMultiSortButton: true,
						sortPriority: (function(){
							if (initialState.sortPriority){
								try { const p = JSON.parse(initialState.sortPriority); if (Array.isArray(p)) return p; } catch(_){}
							}
							return [
								{ sortName: TrdFormatters.getFieldName('Record Date'), sortOrder: 'desc' },
								{ sortName: TrdFormatters.getFieldName('Sale Price'), sortOrder: 'desc' },
							];
						})(),
						onLoadSuccess: function(){ ensureMultiSortButtonInPagination(true); },
						onPageChange: function(){ ensureMultiSortButtonInPagination(); },
						onPostBody: function(){ ensureMultiSortButtonInPagination(); }
					});

					// Apply initial search and county from state
					if (initialState.search){ document.getElementById('global-search').value = initialState.search; $(tableEl).bootstrapTable('resetSearch', initialState.search); }
					if (initialState.county){
						const sel = document.getElementById('county-filter');
						sel.value = initialState.county;
						sel.dispatchEvent(new Event('change'));
					} else {
						// Default to All Counties and apply consistent center/zoom
						const sel = document.getElementById('county-filter');
						sel.value = 'All';
						sel.dispatchEvent(new Event('change'));
					}
					if (initialState.pageNumber){ $(tableEl).bootstrapTable('selectPage', parseInt(initialState.pageNumber,10)); }
				}

					function ensureMultiSortButtonInPagination(withRetry){
						// Target within the Bootstrap Table wrapper to be robust
						const wrapper = document.querySelector('#table').closest('.bootstrap-table');
						if (!wrapper) return;
						const host = wrapper.querySelector('.fixed-table-pagination .pagination-detail')
							|| wrapper.querySelector('.fixed-table-pagination .page-list')
							|| wrapper.querySelector('.fixed-table-pagination .pagination');
						if (!host) return;
						let btn = host.querySelector('.multi-sort-inline-btn');
						if (!btn){
							btn = document.createElement('button');
							btn.type = 'button';
							btn.className = 'btn btn-sm btn-primary multi-sort-inline-btn ms-3';
							btn.innerHTML = '<i class="bi bi-sliders"></i> Multi Sort';
							btn.addEventListener('click', function(){
								openMultiSortModal();
							});
							// Create an inline controls cluster on the pagination row
							let cluster = host.querySelector('.inline-controls-cluster');
							if (!cluster){
								cluster = document.createElement('div');
								cluster.className = 'inline-controls-cluster d-flex align-items-center gap-2 ms-2';
								// Insert cluster before the page-list (if present) so it sits alongside
								const pageList = wrapper.querySelector('.fixed-table-pagination .page-list');
								if (pageList && pageList.parentNode === host){ host.insertBefore(cluster, pageList); }
								else { host.appendChild(cluster); }
							}
							cluster.appendChild(btn);
							// Add Export CSV into the cluster (only once)
							if (!cluster.querySelector('.export-csv-btn')){
								const eb = document.createElement('button');
								eb.type='button'; eb.className='btn btn-sm btn-outline-secondary export-csv-btn';
								eb.innerHTML = '<i class="bi bi-download"></i> Export CSV';
								eb.addEventListener('click', ()=>{
									const data = $('#table').bootstrapTable('getData', true) || [];
									const cols = $('#table').bootstrapTable('getOptions').columns[0];
									const headers = cols.filter(c=>c.visible!==false).map(c=>c.title);
									const fields = cols.filter(c=>c.visible!==false).map(c=>c.field);
									const csvRows = [headers.join(',')].concat(data.map(row => fields.map(f => {
										let v = row[f]; if (v === undefined || v === null) return '';
										v = (typeof v === 'string') ? v.replace(/"/g,'""') : v;
										return '"' + v + '"';
									}).join(',')));
									const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
									const url = URL.createObjectURL(blob);
									const a = document.createElement('a'); a.href = url; a.download = 'south-florida-transactions.csv'; a.click();
									URL.revokeObjectURL(url);
								});
								cluster.appendChild(eb);
							}
							// Move Show Columns dropdown into the cluster to keep all controls reachable
							const btToolbar = wrapper.querySelector('.fixed-table-toolbar');
							const showCols = btToolbar && btToolbar.querySelector('.keep-open');
							if (showCols && !cluster.querySelector('.keep-open')){ cluster.appendChild(showCols); }
						}
						// Optional retry to catch late-rendered pagination on initial load
						if (withRetry){
							let attempts = 0;
							const timer = setInterval(()=>{
								attempts++;
								const wrap2 = document.querySelector('#table').closest('.bootstrap-table');
								const host2 = wrap2 && (wrap2.querySelector('.fixed-table-pagination .pagination-detail')
									|| wrap2.querySelector('.fixed-table-pagination .page-list')
									|| wrap2.querySelector('.fixed-table-pagination .pagination'));
								if (host2 && !host2.querySelector('.multi-sort-inline-btn')){
									let cluster2 = host2.querySelector('.inline-controls-cluster');
									if (!cluster2){
										cluster2 = document.createElement('div');
										cluster2.className = 'inline-controls-cluster d-flex align-items-center gap-2 ms-2';
										const pageList2 = wrap2.querySelector('.fixed-table-pagination .page-list');
										if (pageList2 && pageList2.parentNode === host2){ host2.insertBefore(cluster2, pageList2); }
										else { host2.appendChild(cluster2); }
									}
									const btn2 = btn.cloneNode(true);
									btn2.addEventListener('click', function(){ openMultiSortModal(); });
									cluster2.appendChild(btn2);
									// Export CSV in retry path
									if (!cluster2.querySelector('.export-csv-btn')){
										const eb2 = document.createElement('button');
										eb2.type='button'; eb2.className='btn btn-sm btn-outline-secondary export-csv-btn';
										eb2.innerHTML = '<i class="bi bi-download"></i> Export CSV';
										eb2.addEventListener('click', ()=>{
											const data = $('#table').bootstrapTable('getData', true) || [];
											const cols = $('#table').bootstrapTable('getOptions').columns[0];
											const headers = cols.filter(c=>c.visible!==false).map(c=>c.title);
											const fields = cols.filter(c=>c.visible!==false).map(c=>c.field);
											const csvRows = [headers.join(',')].concat(data.map(row => fields.map(f => {
												let v = row[f]; if (v === undefined || v === null) return '';
												v = (typeof v === 'string') ? v.replace(/"/g,'""') : v;
												return '"' + v + '"';
											}).join(',')));
											const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
											const url = URL.createObjectURL(blob);
											const a = document.createElement('a'); a.href = url; a.download = 'south-florida-transactions.csv'; a.click();
											URL.revokeObjectURL(url);
										});
										cluster2.appendChild(eb2);
									}
									// Move Show Columns dropdown into cluster2
									const btToolbar2 = wrap2.querySelector('.fixed-table-toolbar');
									const showCols2 = btToolbar2 && btToolbar2.querySelector('.keep-open');
									if (showCols2 && !cluster2.querySelector('.keep-open')){ cluster2.appendChild(showCols2); }
									clearInterval(timer);
								}
								if (attempts >= 10) clearInterval(timer);
							}, 100);
						}
					}
			// Multi Sort modal logic for Bootstrap 5
			function openMultiSortModal(){
				const modalEl = document.getElementById('multiSortModal');
				if (!modalEl) return;
				buildMultiSortRows();
				const modal = new bootstrap.Modal(modalEl);
				modal.show();
			}

			function buildMultiSortRows(){
				const container = document.getElementById('multi-sort-rows');
				if (!container) return;
				container.innerHTML = '';
				const options = displayColumns
					.filter(dc => dc.visible !== false) // allow hidden? keep simple
					.map(dc => ({ label: dc.name || dc.dataField, value: TrdFormatters.getFieldName(dc.dataField) }));
				const existing = $('#table').bootstrapTable('getOptions').sortPriority || [];
				const rows = existing.length ? existing : [{ sortName: TrdFormatters.getFieldName('Record Date'), sortOrder: 'desc' }];
				rows.forEach(rule => container.appendChild(createSortRow(options, rule)));
			}

			function createSortRow(options, rule){
				const row = document.createElement('div');
				row.className = 'd-flex align-items-center gap-2';
				const colSel = document.createElement('select');
				colSel.className = 'form-select form-select-sm';
				options.forEach(opt => {
					const o = document.createElement('option');
					o.value = opt.value; o.textContent = opt.label; colSel.appendChild(o);
				});
				colSel.value = rule && rule.sortName ? rule.sortName : options[0]?.value;
				const orderSel = document.createElement('select');
				orderSel.className = 'form-select form-select-sm';
				['asc','desc'].forEach(ord => { const o=document.createElement('option'); o.value=ord; o.textContent=ord.toUpperCase(); orderSel.appendChild(o); });
				orderSel.value = rule && rule.sortOrder ? rule.sortOrder : 'asc';
				const removeBtn = document.createElement('button');
				removeBtn.type = 'button'; removeBtn.className = 'btn btn-sm btn-outline-danger';
				removeBtn.innerHTML = '<i class="bi bi-x-circle"></i>';
				removeBtn.addEventListener('click', () => row.remove());
				row.appendChild(colSel);
				row.appendChild(orderSel);
				row.appendChild(removeBtn);
				return row;
			}

			document.getElementById('add-sort-row').addEventListener('click', () => {
				const container = document.getElementById('multi-sort-rows');
				const options = displayColumns.map(dc => ({ label: dc.name || dc.dataField, value: TrdFormatters.getFieldName(dc.dataField) }));
				container.appendChild(createSortRow(options, { sortName: options[0]?.value, sortOrder: 'asc' }));
			});

			document.getElementById('apply-multi-sort').addEventListener('click', () => {
				const container = document.getElementById('multi-sort-rows');
				const rules = Array.from(container.querySelectorAll('.d-flex')).map(row => {
					const selects = row.querySelectorAll('select');
					return { sortName: selects[0].value, sortOrder: selects[1].value };
				}).filter(r => r.sortName);
				$('#table').bootstrapTable('refreshOptions', { sortPriority: rules });
				setState({ sortPriority: JSON.stringify(rules) });
				// Close modal
				const modalEl = document.getElementById('multiSortModal');
				bootstrap.Modal.getInstance(modalEl)?.hide();
			});

			})();

			// Removed $5M toggle handlers and caches; county filter controls visible data

			// Global search -> table and map (if supported)
			const globalSearch = document.getElementById("global-search");
			const searchSuggestions = document.getElementById("search-suggestions");
			let searchHighlightMarker = null;
			let searchDebounce;

			function renderSuggestions(text){
				if (!text){ searchSuggestions.classList.remove('show'); searchSuggestions.innerHTML = ''; return; }
				const rows = $("#table").bootstrapTable("getData", false) || [];
				const lower = text.toLowerCase();
				const matches = rows.filter(r => {
					const values = Object.values(r).filter(v => typeof v === 'string' || typeof v === 'number');
					return values.join(' ').toLowerCase().includes(lower);
				}).slice(0, 10);
				if (matches.length === 0){ searchSuggestions.classList.remove('show'); searchSuggestions.innerHTML = ''; return; }
				searchSuggestions.innerHTML = matches.map(m => {
					const addr = m[TrdFormatters.getFieldName('Physical Address')] || m[TrdFormatters.getFieldName('Address')] || 'Address N/A';
					const price = m[TrdFormatters.getFieldName('Sale Price')];
					const county = m[TrdFormatters.getFieldName('County')] || '';
					const priceText = (typeof price === 'number') ? TrdFormatters.formatPrice(price) : (price || '');
					const displayText = addr; // use address as the search text
					return `<button type="button" class="dropdown-item" data-text="${displayText.replace(/"/g,'&quot;')}" data-coords="${(m.__coords||[]).join(',')}"><strong>${addr}</strong><br/><small>${priceText} ${county? '· '+county : ''}</small></button>`;
				}).join('');
				searchSuggestions.classList.add('show');
			}

			function flyToCoords(coords){
				if (!Array.isArray(coords)) return;
				const center = [coords[0], coords[1]];
				try {
					const mapInstance = (window.map && window.map._map) ? window.map._map : (window.map.map || window.map);
					const fly = (mapInstance && typeof mapInstance.flyTo === 'function') ? mapInstance.flyTo.bind(mapInstance) : (window.map.flyTo || (window.map.map && window.map.map.flyTo));
					if (typeof fly === 'function') fly({ center, zoom: 13, essential: true });
				} catch(_){}
				try {
					if (searchHighlightMarker) { searchHighlightMarker.remove(); searchHighlightMarker = null; }
					const el = document.createElement('div'); el.className = 'search-highlight-marker';
					const mapInstance = (window.map && window.map._map) ? window.map._map : (window.map.map || window.map);
					searchHighlightMarker = new mapboxgl.Marker({ element: el, anchor: 'center' }).setLngLat(center).addTo(mapInstance);
					setTimeout(() => { if (searchHighlightMarker) { searchHighlightMarker.remove(); searchHighlightMarker = null; } }, 5000);
				} catch(_){}
			}

			// Input: updates table + suggestions; map only on Enter
			globalSearch.addEventListener("input", (e) => {
				clearTimeout(searchDebounce);
				const text = (e.target.value || "").trim();
				searchDebounce = setTimeout(()=>{
					$("#table").bootstrapTable("resetSearch", text);
					const $tbodyRows = $("#table").find("tbody tr");
					$tbodyRows.removeClass("table-row-highlight");
					if (text.length > 0) {
						$tbodyRows.each(function(){
							const rowText = $(this).text().toLowerCase();
							if (rowText.includes(text.toLowerCase())) { $(this).addClass("table-row-highlight"); }
						});
					}
					setState({ search: text });
					renderSuggestions(text);
				}, 200);
			});

			// Enter triggers map search/fly; Escape closes suggestions
			globalSearch.addEventListener('keydown', (e) => {
				if (e.key === 'Escape'){ searchSuggestions.classList.remove('show'); }
				if (e.key !== 'Enter') return;
				const text = (globalSearch.value || '').trim();
				if (!text) return;
				// Map's built-in search UI is disabled; use table match
				const rows = $("#table").bootstrapTable("getData", false) || [];
				const lower = text.toLowerCase();
				const match = rows.find(r => {
					const values = Object.values(r).filter(v => typeof v === 'string' || typeof v === 'number');
					return values.join(' ').toLowerCase().includes(lower);
				});
				if (match && Array.isArray(match.__coords)) flyToCoords(match.__coords);
				searchSuggestions.classList.remove('show');
			});

			// Suggestion click -> fly to that entry
			searchSuggestions.addEventListener('click', (e) => {
				const item = e.target.closest('.dropdown-item');
				if (!item) return;
				const text = item.getAttribute('data-text') || '';
				if (text){
					globalSearch.value = text;
					// Immediately sync table search and state
					$("#table").bootstrapTable("resetSearch", text);
					setState({ search: text });
				}
				const raw = item.getAttribute('data-coords') || '';
				const coords = raw.split(',').map(v => parseFloat(v)).filter(v => !Number.isNaN(v));
				if (coords.length === 2) flyToCoords(coords);
				searchSuggestions.classList.remove('show');
				globalSearch.focus();
			});

			// County dropdown -> filter table & map
			const countySelect = document.getElementById("county-filter");
			// Global navigation lock to avoid competing animations
			window.__mapNavLockUntil = window.__mapNavLockUntil || 0;
			countySelect.addEventListener("change", () => {
				// Known county centers to avoid snapping to wrong spots
				const COUNTY_CENTERS = {
					'Miami-Dade': [-80.1918, 25.7617],
					'Broward': [-80.3659, 26.1901],
					'Palm Beach': [-80.2767, 26.6515]
				};
				const selected = countySelect.value;
				// Capture current table state to persist
				const opts = $("#table").bootstrapTable('getOptions') || {};
				const currentSearch = (document.getElementById('global-search')?.value || '').trim();
				const currentSortName = opts.sortName;
				const currentSortOrder = opts.sortOrder;
				const currentSortPriority = opts.sortPriority || [];
				const currentPageSize = opts.pageSize;
				const currentPageNumber = opts.pageNumber;

				// Table: filter by County from original full dataset
				const sourceRows = Array.isArray(window.originalRows) ? window.originalRows : ([]);
				const countyFiltered = selected === "All" ? sourceRows : sourceRows.filter((row) => row[TrdFormatters.getFieldName("County")] === selected);
				// Reload data, then restore search and sort
				$("#table").bootstrapTable("load", countyFiltered);
				// Reapply sort priority and primary sort
				$("#table").bootstrapTable('refreshOptions', {
					sortPriority: currentSortPriority,
					sortName: currentSortName,
					sortOrder: currentSortOrder
				});
				// Reapply search text
				$("#table").bootstrapTable("resetSearch", currentSearch);
				// Reapply page size and number
				if (currentPageSize) $("#table").bootstrapTable('refreshOptions', { pageSize: currentPageSize });
				if (currentPageNumber) $("#table").bootstrapTable('selectPage', currentPageNumber);
				// Persist to state
				setState({ county: selected, search: currentSearch, sortName: currentSortName, sortOrder: currentSortOrder, sortPriority: JSON.stringify(currentSortPriority), pageSize: currentPageSize, pageNumber: currentPageNumber });

				// Smoothly move the map: use a single animation to avoid jitter
				try {
					const mapInstance = (window.map && window.map._map) ? window.map._map : (window.map.map || window.map);
					if (!mapInstance) { /* no-op */ }
					// Stop any ongoing animation to prevent jitter, then proceed
					if (typeof mapInstance.stop === 'function') { mapInstance.stop(); }
					if (selected === 'All') {
						// All Counties center: [lng, lat]
						const allCenter = new mapboxgl.LngLat(-80.09429790707776, 26.23707354237017);
						if (typeof mapInstance.easeTo === 'function') {
							mapInstance.easeTo({ center: allCenter, zoom: 8, duration: 600, essential: true });
						} else if (typeof mapInstance.flyTo === 'function') {
							mapInstance.flyTo({ center: allCenter, zoom: 8, essential: true });
						}
					} else {
						// Specific county: use same zoom as All for consistency
						const center = COUNTY_CENTERS[selected];
						if (center && typeof mapInstance.easeTo === 'function') {
							mapInstance.easeTo({ center: new mapboxgl.LngLat(center[0], center[1]), zoom: 8, duration: 600, essential: true });
						} else if (center && typeof mapInstance.flyTo === 'function') {
							mapInstance.flyTo({ center: new mapboxgl.LngLat(center[0], center[1]), zoom: 8, essential: true });
						}
					}
					// Lock further programmatic navigation briefly
					window.__mapNavLockUntil = Date.now() + 900;
				} catch(_){ }

				// Map: filter points by county via Mapbox expression filter if available
				try {
					const mapInstance = (window.map && window.map._map) ? window.map._map : (window.map.map || window.map);
					if (!mapInstance || typeof mapInstance.getStyle !== 'function' || typeof mapInstance.setFilter !== 'function') return;
					// Determine target layers: prefer explicit layerId, else all circle layers
					const targetLayerIds = [];
					const explicitId = (window.map && window.map.layerId) ? window.map.layerId : null;
					if (explicitId) { targetLayerIds.push(explicitId); }
					else {
						const style = mapInstance.getStyle();
						(style.layers || []).forEach(l => { if (l && l.type === 'circle') targetLayerIds.push(l.id); });
					}
					const filterExpr = (selected === 'All') ? null : ['==', ['get','County'], selected];
					for (const lid of targetLayerIds) {
						try { mapInstance.setFilter(lid, filterExpr); } catch(__){}
					}
				} catch (_) {}
			});

			// Table row hover -> map center highlight
			(function(){
				// On row click, center the map on the row's coordinates
				$('#table').on('click', 'tbody tr', function(){
					const idx = $(this).data('index');
					const row = $('#table').bootstrapTable('getData')[idx];
					if (row && Array.isArray(row.__coords)){
						const center = [row.__coords[0], row.__coords[1]];
						try {
							const mapInstance = (window.map && window.map._map) ? window.map._map : (window.map.map || window.map);
							if (mapInstance && typeof mapInstance.easeTo === 'function'){
								mapInstance.easeTo({ center, zoom: Math.max((mapInstance.getZoom?.()||13), 13), duration: 500, essential: true });
							} else if (mapInstance && typeof mapInstance.flyTo === 'function'){
								mapInstance.flyTo({ center, zoom: Math.max((mapInstance.getZoom?.()||13), 13), essential: true });
							}
						} catch(_){ }
					}
				});
			})();
		</script>
	</body>
</html>
