<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
		<meta name="robots" content="noindex, nofollow" />
		<title>South Florida Transactions — Map & Table</title>
		<link rel="icon" type="image/x-icon" href="https://therealdeal.com/favicon.ico" />
		<link rel="canonical" href="https://therealdeal.com/data/" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="true" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@0,400;0,700;0,900&display=swap" />
		<link rel="stylesheet" href="https://static.therealdeal.com/ProximaNovaFontFamily/ProximaNova/proxima-nova-all.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" />
		<link rel="stylesheet" href="../trd-data/common-map/map.css" />
		<link rel="stylesheet" href="../trd-data/common-table/table.css" />
		<!-- Google Tag Manager -->
		<script>
			(function (w, d, s, l, i) {
				w[l] = w[l] || [];
				w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
				var f = d.getElementsByTagName(s)[0],
					j = d.createElement(s),
					dl = l != "dataLayer" ? "&l=" + l : "";
				j.async = true;
				j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
				f.parentNode.insertBefore(j, f);
			})(window, document, "script", "dataLayer", "GTM-K694XL6");
		</script>
		<!-- End Google Tag Manager -->
		<style>
			main { margin-top: 56px; }
			.map-height { min-height: 60vh; }
		</style>
	</head>
	<body>
		<!-- Google Tag Manager (noscript) -->
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K694XL6" height="0" width="0" style="display: none; visibility: hidden"></iframe></noscript>
		<!-- End Google Tag Manager (noscript) -->
		<nav class="navbar fixed-top navbar-light bg-light border-bottom">
			<div class="container-fluid">
				<span class="navbar-brand mb-0 h6">South Florida Transactions</span>
				<div class="d-flex align-items-center gap-2">
					<div class="input-group input-group-sm" style="width: 320px;">
						<span class="input-group-text"><i class="bi bi-search"></i></span>
						<input id="global-search" type="text" class="form-control" placeholder="Search address, folio, seller, buyer" />
					</div>
					<div class="input-group input-group-sm" style="width: 220px;">
						<span class="input-group-text"><i class="bi bi-geo"></i></span>
						<select id="county-filter" class="form-select">
							<option value="All">All Counties</option>
							<option value="Miami-Dade">Miami-Dade</option>
							<option value="Palm Beach">Palm Beach</option>
							<option value="Broward">Broward</option>
						</select>
					</div>
				</div>
			</div>
		</nav>
		<main class="container-fluid py-3">
			<div class="row g-3">
				<!-- Map Column -->
				<div class="col-12 col-lg-6">
					<div class="card">
						<div class="card-header">South Florida Transactions Map</div>
						<div class="card-body">
							<section id="map" class="map map-height"></section>
							<!-- Optional: legend & filters containers if used by map.js -->
							<div id="legend" class="mt-2"></div>
							<div id="map-filters" class="mt-2"></div>
							<div id="result" class="mt-2"></div>
						</div>
					</div>
				</div>

				<!-- Table Column -->
				<div class="col-12 col-lg-6">
					<div class="card">
						<div class="card-header d-flex justify-content-between align-items-center">
							<span>South Florida Sales Table</span>
							<div class="btn-group btn-group-sm" role="group" aria-label="Sales filter">
								<button type="button" id="btn-all-sales" class="btn btn-outline-primary active">All sales</button>
								<button type="button" id="btn-recent-5m" class="btn btn-outline-primary">Recent $5M+ sales</button>
							</div>
						</div>
						<div class="card-body">
							<div class="alert alert-info mb-3" role="alert">
								<i class="bi bi-info-circle"></i>
								<strong>Tip:</strong>
								Click any column header to sort by that column.
								To sort by multiple columns, use the <strong>“Multiple Sort”</strong> button to the right of the search bar.
							</div>
							<table id="table"></table>
						</div>
					</div>
				</div>
			</div>
		</main>

		<!-- Core libs -->
		<script src="https://experience.tinypass.com/xbuilder/experience/load?aid=p7sVIGTDn5"></script>
		<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<!-- Bootstrap Table -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.2/dist/bootstrap-table.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.2/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.2/dist/extensions/multiple-sort/bootstrap-table-multiple-sort.min.js"></script>
		<!-- Mapbox GL -->
		<script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
		<!-- TRD shared -->
		<script src="https://static.therealdeal.com/library/theme.js?v=1.0"></script>
		<script src="../trd-data/common-formatter/formatter.js"></script>
		<script src="../trd-data/common-loading/loading.js"></script>
		<script src="../trd-data/common-map/map.js?v=1.1"></script>
		<script src="../trd-data/common-table/table.js"></script>

		<script>
			// Shared constants/config
			const filePaths = [
				"miami_dade_output.geojson",
				"palm_beach_output.geojson",
				"broward_output.geojson",
			];

			const legendKeys = [
				{
					title: "Sales",
					options: [
						{ value: 100_000, color: { light: "#90CAF9", dark: "#90CAF9" }, text: "< $500K", default: false },
						{ value: 750_000, color: { light: "#42A5F5", dark: "#42A5F5" }, text: "$500K - $750K", default: false },
						{ value: 1_000_000, color: { light: "#1E88E5", dark: "#1E88E5" }, text: "$750K - $1M", default: false },
						{ value: 5_000_000, color: { light: "#1565C0", dark: "#1565C0" }, text: "$1M - $5M", default: false },
						{ value: 10_000_000, color: { light: "#0D47A1", dark: "#0D47A1" }, text: "> $10M", default: true },
					],
				},
				{
					title: "Mortgage",
					options: [
						{ value: "mortgage", color: { light: "#FF9800", dark: "#FF9800" }, text: "Orange stroke = Mortgage", default: false, isStroke: true },
					],
				},
			];

			const tooltipDisplayFields = {
				title: { field: "Physical Address", label: "Address" },
				content: [
					{ field: "Sale Price", label: "Sale Price", format: "formatPrice" },
					{ field: "Loan Amount", label: "Loan Amount", format: "formatPrice" },
					{ field: "Description", label: "Use Code" },
					{ field: "Record Date", label: "Record Date", format: "formatDate" },
				],
			};

			const modalDisplayFields = {
				title: { field: "Physical Address", label: "Address" },
				content: [
					{ field: "Doc Type", label: "Doc Type" },
					{ field: "Seller", label: "Seller" },
					{ field: "Buyer", label: "Buyer" },
					{ field: "Sale Price", label: "Sale Price", format: "formatPrice" },
					{ field: "Loan Amount", label: "Loan Amount", format: "formatPrice" },
					{ field: "Record Date", label: "Record Date", format: "formatDate" },
					{ field: "Folio", label: "Folio" },
					{ field: "Description", label: "Use Code Description" },
					{ field: "Acres", label: "Lot Size" },
					{ field: "Previous Owner Name", label: "Previous Owner Name" },
					{ field: "Previous Sale Price", label: "Previous Sale Price" },
				],
			};

			const fetchDataFilterCallback = (data) => {
				return {
					...data,
					features: data.features.map((feature) => ({
						...feature,
						properties: {
							...feature.properties,
							"Use Code Description": feature.properties["Description"] || null,
							"Sale Price": TrdFormatters.getNumberValue(
								feature.properties["Sale Price"] || feature.properties["Consideration"] || null
							),
							"Loan Amount": TrdFormatters.getNumberValue(feature.properties["Loan Amount"] || null),
							"Previous Sale Date": feature.properties["Previous Sale Date"] || feature.properties["Date of Previous Sale"] || null,
						},
					})),
				};
			};

			// Init Map
			window.map = trdDataCommonMap({
				filePaths,
				fileAddKeyValues: [
					{ County: "Miami-Dade" },
					{ County: "Palm Beach" },
					{ County: "Broward" },
				],
				eventCategory: "south-florida-transactions-map",
				mapElementId: "map",
				filterElementId: "map-filters",
				legendElementId: "legend",
				resultElementId: "result",
				mapCenterLat: 26.380126753919782,
				mapCenterLng: -80.38513016032842,
				zoom: 8,
				minZoom: 8,
				legendKeys,
				dataPointKeys: legendKeys[0].options,
				tooltipDisplayFields,
				modalDisplayFields,
				fetchDataFilterCallback,
				loadingEnabled: true,
				mapLayerPaint: {
					'circle-stroke-width': [
						"case",
						[">", ["to-number", ["get", "Loan Amount"], 0], 0],
						2,
						0
					],
					'circle-stroke-color': "#FF9800",
				},
				pointSettings: {
					clickToCenter: true,
					clickToZoom: true,
					colorType: "step",
					radiusType: "radius",
					colorTypeDataKey: "Sale Price",
					paintSettings: {
						hover: { color: { light: "#FF9800", dark: "#F57C00" } },
						active: { color: { light: "#FF5722", dark: "#D84315" } },
						default: { radius: 4 },
					},
				},
				searchSettings: {
					enable: true,
					placeholderText: "Search by address, folio, seller, buyer...",
					resultTitleField: "Address",
					searchFields: ["Address", "Folio", "Buyer", "Seller"],
				},
				filterFields: [
					{
						title: "County",
						name: "county",
						dataField: "County",
						fieldType: "radio",
						fieldLayoutClass: "radio-group",
						multiSelect: false,
						defaultValue: "All",
						callback: (values, item) => {
							const v = values[0];
							if (!v || v === "All") return true;
							return item.properties && item.properties["County"] === v;
						},
						options: [
							{ label: "All Counties", value: "All" },
							{ label: "Miami-Dade", value: "Miami-Dade" },
							{ label: "Palm Beach", value: "Palm Beach" },
							{ label: "Broward", value: "Broward" },
						],
					},
				],
			});

			// Table columns
			const displayColumns = [
				{ dataField: "Physical Address", name: "Address", visible: true },
				{ dataField: "Sale Price", name: "Sale Price", visible: true, formatter: TrdFormatters.formatPrice, sortable: true },
				{ dataField: "Loan Amount", name: "Loan Amount", visible: true, formatter: TrdFormatters.formatPrice, sortable: true },
				{ dataField: "Record Date", name: "Record Date", visible: true, formatter: TrdFormatters.formatDate, sorter: TrdSorters.sortDate, sortable: true },
				{ dataField: "Use Code Description", name: "Description", visible: true, sortable: true },
				{ dataField: "Seller", name: "Seller", visible: true, sortable: true },
				{ dataField: "Buyer", name: "Buyer", visible: true, sortable: true },
				{ dataField: "Doc Type", name: "Doc Type", visible: false },
				{ dataField: "Folio", name: "Folio", visible: false },
				{ dataField: "Previous Owner Name", name: "Previous Owner Name", visible: false },
				{ dataField: "Previous Sale Price", name: "Previous Sale Price", visible: false },
			];

			const tableFilterCallback = (data) => {
				return new Promise((resolve) => {
					const filteredData = data.features.map((item, _i) => ({
						...item.properties,
						"Use Code Description": item.properties["Description"] || null,
						"Sale Price": TrdFormatters.getNumberValue(
							item.properties["Sale Price"] || item.properties["Consideration"] || null
						),
						"Loan Amount": TrdFormatters.getNumberValue(item.properties["Loan Amount"] || null),
						"Previous Sale Date": item.properties["Previous Sale Date"] || item.properties["Date of Previous Sale"] || null,
					}));
					resolve(filteredData);
				});
			};

			// Init Table
			TrdDataCommonTable({
				filePaths,
				fileAddKeyValues: [
					{ County: "Miami-Dade" },
					{ County: "Palm Beach" },
					{ County: "Broward" },
				],
				eventCategory: "south-florida-transactions-table",
				displayColumns,
				fetchDataFilterCallback: tableFilterCallback,
				tableConfig: {
					sortName: TrdFormatters.getFieldName("Record Date"),
					sortOrder: "desc",
					sortStable: true,
					sortResetPage: true,
					search: true,
					searchSelector: "#global-search",
					showMultiSort: true,
					showMultiSortButton: true,
					sortPriority: [
						{ sortName: TrdFormatters.getFieldName("Record Date"), sortOrder: "desc" },
						{ sortName: TrdFormatters.getFieldName("Sale Price"), sortOrder: "desc" },
					],
				},
			});

			// Table filter buttons logic
			let allRowsCache = [];
			let recent5mRowsCache = [];
			const RECORD_DATE_FIELD = TrdFormatters.getFieldName("Record Date");
			const SALE_PRICE_FIELD = TrdFormatters.getFieldName("Sale Price");

			function refreshAllRowsCache() {
				const rows = $("#table").bootstrapTable("getData", false) || [];
				allRowsCache = rows.slice();
				recent5mRowsCache = [];
			}

			$("#table").on("load-success.bs.table", function () {
				refreshAllRowsCache();
			});

			function computeRecent5mRows() {
				if (!allRowsCache || !allRowsCache.length) return [];
				const dateStrings = Array.from(new Set(allRowsCache.map((row) => row[RECORD_DATE_FIELD]).filter((d) => d != null && d !== "")));
				if (dateStrings.length === 0) return [];
				dateStrings.sort((a, b) => new Date(b) - new Date(a));
				const cutoffDates = new Set(dateStrings.slice(0, 2));
				const filtered = allRowsCache.filter((row) => {
					const price = Number(row[SALE_PRICE_FIELD]) || 0;
					const recordDate = row[RECORD_DATE_FIELD];
					return price >= 5000000 && cutoffDates.has(recordDate);
				});
				filtered.sort((a, b) => (Number(b[SALE_PRICE_FIELD]) || 0) - (Number(a[SALE_PRICE_FIELD]) || 0));
				return filtered;
			}

			$("#btn-recent-5m").on("click", function () {
				if (!allRowsCache.length) { refreshAllRowsCache(); }
				if (!recent5mRowsCache.length) { recent5mRowsCache = computeRecent5mRows(); }
				$("#table").bootstrapTable("load", recent5mRowsCache);
				$(this).addClass("active");
				$("#btn-all-sales").removeClass("active");
			});

			$("#btn-all-sales").on("click", function () {
				if (!allRowsCache.length) { refreshAllRowsCache(); }
				$("#table").bootstrapTable("load", allRowsCache);
				$(this).addClass("active");
				$("#btn-recent-5m").removeClass("active");
			});

			// Global search -> table and map (if supported)
			const globalSearch = document.getElementById("global-search");
			globalSearch.addEventListener("input", (e) => {
				const text = e.target.value || "";
				// Table search via built-in support
				$("#table").bootstrapTable("resetSearch", text);
				// Try to forward to map search if API exists
				if (window.map && typeof window.map.search === "function") {
					try { window.map.search(text); } catch (err) {}
				}
			});

			// County dropdown -> filter table & map
			const countySelect = document.getElementById("county-filter");
			countySelect.addEventListener("change", () => {
				const selected = countySelect.value;
				// Table: filter cache by County
				if (!allRowsCache.length) { refreshAllRowsCache(); }
				const countyFiltered = selected === "All" ? allRowsCache : allRowsCache.filter((row) => row[TrdFormatters.getFieldName("County")] === selected);
				$("#table").bootstrapTable("load", countyFiltered);

				// Map: update filter field programmatically if supported by map UI
				// Fallback: trigger internal filters via custom event if library supports it
				try {
					const filtersEl = document.getElementById("map-filters");
					if (filtersEl) {
						// Attempt to find a radio matching value and click it
						const inputs = filtersEl.querySelectorAll('input[type="radio"][name="county"]');
						inputs.forEach((input) => {
							if (input.value === selected) { input.click(); }
							if (selected === "All" && input.value === "All") { input.click(); }
						});
					}
				} catch (e) {}
			});
		</script>
	</body>
</html>
